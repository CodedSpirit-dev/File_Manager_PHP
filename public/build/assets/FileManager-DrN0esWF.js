import{q as ke,r as n,j as o}from"./app-mKk56eB_.js";import{F as Re,B as Oe,a as Ae}from"./Toolbar-CH2N5prs.js";import V from"./Modal-B9-73j_u.js";import Te from"./FileManagerModal-BRVzpubE.js";import{G as Z}from"./index-Ckl-Sx3k.js";import{getFilesTree as Be,createFolder as De,uploadDirectory as Ue,uploadFile as Le,downloadFile as Ve,downloadFolder as $e,deleteFile as Pe,deleteFolder as He,copyFile as ze,moveFile as Ge,renameFile as qe}from"./fileManagerApi-C7eu-B-H.js";import Ke from"./Breadcrumb-DpEgOd7U.js";import"./FileViewer-DLSlUt1l.js";function Je(f){return Z({tag:"svg",attr:{viewBox:"0 0 384 512"},child:[{tag:"path",attr:{d:"M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"},child:[]}]})(f)}function Qe(f){return Z({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M464 128H272l-64-64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48z"},child:[]}]})(f)}const tr=()=>{var J;const{auth:f}=ke().props,_=((J=f.user)==null?void 0:J.permissions)||[],[a,u]=n.useState(null),[d,M]=n.useState([]),[c,w]=n.useState("public"),[$,ee]=n.useState([]),[re,C]=n.useState(!1),[I,P]=n.useState(""),[H,z]=n.useState(!1),[E,oe]=n.useState(null),[h,k]=n.useState(!1),[R,O]=n.useState(null),[x,A]=n.useState(!1),[T,B]=n.useState(null),[se,D]=n.useState(!1),[te,ne]=n.useState(""),[ae,le]=n.useState(""),[We,ie]=n.useState("success"),[y,g]=n.useState(!1),[N,j]=n.useState(""),[U,F]=n.useState(""),[v,L]=n.useState(!0);n.useEffect(()=>{p(),u(null)},[]),n.useEffect(()=>{ce($,c),u(null)},[c,$]);const p=async()=>{try{const r={name:"public",path:"public",type:"folder",children:await Be()};ee([r])}catch(e){console.error("Error fetching files tree:",e),s("Error","Error al obtener el árbol de archivos.","error")}},ce=(e,r)=>{var Q,W;const t=r.split("/").filter(Boolean);let l={children:e};for(const b of t){const X=(Q=l.children)==null?void 0:Q.find(Y=>Y.name===b&&Y.type==="folder");if(X)l=X;else{console.error("Ruta no encontrada en el árbol:",r),M([]);return}}let m=1;const i=((W=l.children)==null?void 0:W.map(b=>({id:m++,name:b.name,type:b.type,date:new Date,path:b.path})))||[];M(i)},de=e=>{w(e)},pe=e=>{var t;switch((t=e.split(".").pop())==null?void 0:t.toLowerCase()){case"aac":return o.jsx(Ae,{});case"ai":return o.jsx(Oe,{});default:return o.jsx(Je,{})}},me=e=>_.includes(e),ue=e=>{u(r=>r===e?null:e)},fe=e=>{var r;if(e.type==="folder")w(e.path);else{const t=(r=e.name.split(".").pop())==null?void 0:r.toLowerCase();t==="pdf"||t==="docx"||t==="xlsx"?(oe({url:`/filemanager/files/view?filename=${encodeURIComponent(e.name)}&path=${encodeURIComponent(c)}`,type:t}),z(!0)):s("Error","Tipo de archivo no soportado para visualización.","error")}},s=(e,r,t)=>{ne(e),le(r),ie(t),D(!0)},he=()=>{C(!0)},xe=async()=>{if(I.trim()===""){s("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const e=await De(I,c);s("Éxito","Carpeta creada exitosamente.","success"),p(),P(""),C(!1)}catch(e){e.response&&e.response.status===403?s("Error","No tienes permiso para crear carpetas.","error"):s("Error","Error al crear la carpeta.","error"),console.error(e)}},ye=async()=>{const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.onchange=async()=>{if(e.files&&e.files.length>0)try{const r=await Ue(e.files,c);s("Éxito","Carpeta subida exitosamente.","success"),p()}catch(r){r.response&&r.response.status===403?s("Error","No tienes permiso para subir carpetas.","error"):s("Error","Error al subir la carpeta.","error"),console.error(r)}},e.click()},ve=async()=>{const e=document.createElement("input");e.type="file",e.onchange=async()=>{if(e.files&&e.files[0])try{const r=await Le(e.files[0],c);s("Éxito","Archivo subido exitosamente.","success"),p()}catch(r){r.response&&r.response.status===403?s("Error","No tienes permiso para subir archivos.","error"):s("Error","Error al subir el archivo.","error"),console.error(r)}},e.click()},be=async()=>{var e,r;if(a){const t=d.find(l=>l.name===a);if(t){if(t.type==="file")try{const l=await Ve(t.name,c),m=window.URL.createObjectURL(new Blob([l])),i=document.createElement("a");i.href=m,i.setAttribute("download",t.name),document.body.appendChild(i),i.click(),(e=i.parentNode)==null||e.removeChild(i),s("Éxito","Archivo descargado exitosamente.","success")}catch(l){l.response&&l.response.status===403?s("Error","No tienes permiso para descargar archivos.","error"):s("Error","Error al descargar el archivo.","error"),console.error(l)}else if(t.type==="folder")try{const l=await $e(t.name,c),m=window.URL.createObjectURL(new Blob([l])),i=document.createElement("a");i.href=m,i.setAttribute("download",`${t.name}.zip`),document.body.appendChild(i),i.click(),(r=i.parentNode)==null||r.removeChild(i),s("Éxito","Carpeta descargada exitosamente.","success")}catch(l){l.response&&l.response.status===403?s("Error","No tienes permiso para descargar carpetas.","error"):s("Error","Error al descargar la carpeta.","error"),console.error(l)}}}else s("Error","Por favor, selecciona un elemento para descargar.","error")},we=async()=>{if(a&&window.confirm(`¿Estás seguro de que deseas eliminar "${a}"?`))try{const r=d.find(t=>t.name===a);if(r){let t;r.type==="file"?t=await Pe(r.name,c):r.type==="folder"&&(t=await He(r.name,c)),s("Éxito",t.message||"Elemento eliminado exitosamente.","success"),p(),u(null)}}catch(r){r.response&&r.response.status===403?s("Error","No tienes permiso para eliminar este elemento.","error"):s("Error","Error al eliminar el elemento.","error"),console.error(r)}},Ce=async()=>{if(a){const e=d.find(r=>r.name===a);e&&e.type==="file"?(O({filename:e.name,path:c}),k(!0)):s("Error","Solo se pueden copiar archivos.","error")}},Ee=async()=>{if(R)try{const e=await ze(R.filename,R.path,c);s("Éxito","Archivo copiado exitosamente.","success"),p(),k(!1),O(null)}catch(e){e.response&&e.response.status===403?s("Error","No tienes permiso para copiar archivos.","error"):s("Error","Error al copiar el archivo.","error"),console.error(e)}},G=()=>{k(!1),O(null)},ge=async()=>{if(a){const e=d.find(r=>r.name===a);e&&e.type==="file"?(B({filename:e.name,path:c}),A(!0)):s("Error","Solo se pueden mover archivos.","error")}},Ne=async()=>{if(T)try{const e=await Ge(T.filename,T.path,c);s("Éxito","Archivo movido exitosamente.","success"),p(),A(!1),B(null),u(null)}catch(e){e.response&&e.response.status===403?s("Error","No tienes permiso para mover archivos.","error"):s("Error","Error al mover el archivo.","error"),console.error(e)}},q=()=>{A(!1),B(null)},je=()=>{if(a){const e=d.find(r=>r.name===a);if(e){const[r,t]=e.type==="file"?[a.slice(0,a.lastIndexOf("."))||a,a.slice(a.lastIndexOf(".")+1)]:[a,""];j(r),F(t),L(e.type==="file"),g(!0)}}},Fe=async e=>{if(e.preventDefault(),N.trim()===""){s("Error","El nombre del elemento no puede estar vacío.","error");return}if(v&&U.trim()===""){s("Error","La extensión del archivo no puede estar vacía.","error");return}const r=v?`${N}.${U}`:N;try{if(a!=null){const t=await qe(a,r,c)}s("Éxito","Elemento renombrado exitosamente.","success"),p(),u(null),g(!1),j(""),F(""),L(!0)}catch(t){t.response&&t.response.status===403?s("Error","No tienes permiso para renombrar este elemento.","error"):s("Error","Error al renombrar el elemento.","error"),console.error(t)}},K=()=>{g(!1),j(""),F(""),L(!0)},Se=({criteria:e,order:r})=>{const t=[...d].sort((l,m)=>{let i=0;return e==="name"&&(i=l.name.localeCompare(m.name)),r==="asc"?i:-i});M(t)},S=n.useCallback(e=>{e.key==="Escape"&&(h&&G(),x&&q(),y&&K())},[h,x,y]);n.useEffect(()=>(h||x||y?window.addEventListener("keydown",S):window.removeEventListener("keydown",S),()=>{window.removeEventListener("keydown",S)}),[h,x,y,S]);const Me=()=>{const e=c.split("/").filter(Boolean);if(e.length>1){e.pop();const r=e.join("/");w(r)}else w("public")},Ie=c!=="public";return o.jsxs(o.Fragment,{children:[o.jsx(Ke,{currentPath:c,onNavigateTo:de}),o.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[o.jsx(Re,{onCreateFolder:he,onUploadFolder:ye,onUploadFile:ve,onDownloadFile:be,onDelete:we,onCopy:Ce,onRename:je,onMove:ge,onSort:Se,isItemSelected:a!==null,hasPermission:me,onCopyHere:Ee,onCancelCopy:G,isCopying:h,onMoveHere:Ne,onCancelMove:q,isMoving:x,onBack:Me,canGoBack:Ie}),o.jsxs(V,{isOpen:re,title:"Crear Nueva Carpeta",onClose:()=>C(!1),children:[o.jsx("input",{type:"text",value:I,onChange:e=>P(e.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),o.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[o.jsx("button",{className:"btn btn-secondary",onClick:()=>C(!1),children:"Cancelar"}),o.jsx("button",{className:"btn btn-primary",onClick:xe,children:"Crear"})]})]}),H&&E&&E.type&&o.jsx(Te,{isOpen:H,title:`Visualizando: ${a}`,fileUrl:E.url,fileType:E.type,onClose:()=>z(!1)}),o.jsx(V,{isOpen:y,title:`Renombrar ${v?"Archivo":"Carpeta"}`,onClose:()=>g(!1),children:o.jsxs("form",{onSubmit:Fe,children:[o.jsxs("div",{className:"flex flex-col space-y-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"label",children:o.jsxs("span",{className:"label-text",children:["Nombre ",v?"de archivo":"de carpeta"]})}),o.jsx("input",{type:"text",value:N,onChange:e=>j(e.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]}),v&&o.jsxs("div",{children:[o.jsx("label",{className:"label",children:o.jsx("span",{className:"label-text",children:"Extensión del archivo"})}),o.jsx("input",{type:"text",value:U,onChange:e=>F(e.target.value),className:"input input-bordered w-full",placeholder:"Extensión (ej: txt, pdf)"})]})]}),o.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[o.jsx("button",{type:"button",className:"btn btn-secondary",onClick:K,children:"Cancelar"}),o.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),o.jsx("div",{className:"p-4",children:d.length===0?o.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):o.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:d.map(e=>o.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center ${a===e.name?"bg-blue-100":"bg-white"} hover:bg-gray-200 transition-colors duration-200`,onClick:()=>ue(e.name),onDoubleClick:()=>fe(e),children:[o.jsx("span",{className:"text-4xl",children:e.type==="folder"?o.jsx(Qe,{}):pe(e.name)}),o.jsx("span",{className:"mt-2 text-center truncate w-full",children:e.name})]},e.id))})})]}),o.jsxs(V,{isOpen:se,title:te,onClose:()=>D(!1),children:[o.jsx("p",{children:ae}),o.jsx("div",{className:"flex justify-end mt-4",children:o.jsx("button",{className:"btn",onClick:()=>D(!1),children:"Aceptar"})})]})]})};export{tr as default};
