import{q as es,r as l,j as s,a as ss}from"./app-CNqh7FaR.js";import{F as ts,B as os,b as rs,c as as,d as ns,e as ls,f as cs,g as is,h as ps,i as ms,j as ds,k as us,l as fs,m as xs,n as ys,o as hs,p as gs,q as js,s as Cs,t as bs,u as Fs,v as ws,x as vs,y as Es,z as Ns,A as Bs,C as Ss,D as Is,E as ks,G as Ms,H as Ps,I as As,J as Os,K as Ts,L as Ds,N as Rs,O as Ls,P as Us,Q as $s,R as Hs,S as zs,T as Vs,U as qs,V as Js,W as Ks,X as _s,Y as Gs,Z as Xs,_ as Ws,a0 as Ys}from"./Toolbar-DhRQCBLX.js";import y from"./Modal-Dw3B5V6I.js";import Qs from"./FileViewerModal-BnKUmkuT.js";import{F as Zs,a as et}from"./FileViewer-Ceh8k4H3.js";import{getFilesTree as st,createFolder as tt,uploadDirectory as ot,uploadFile as rt,downloadFile as at,downloadFolder as nt,deleteFile as lt,deleteFolder as ct,copyItems as it,moveItems as pt,renameItem as mt}from"./fileManagerApi-KllQ-vnp.js";import dt from"./Breadcrumb-BydDWPxr.js";import"./iconBase-CsYLzCxH.js";import"./index-Chnl_Txm.js";import"./AuthProvider-Dy0b0h8X.js";import"./portal-BNx2HT_V.js";import"./use-server-handoff-complete-DrGpJOMD.js";const Nt=()=>{var ye;const{auth:he}=es().props;(ye=he.user)!=null&&ye.permissions;const[m,h]=l.useState([]),[d,q]=l.useState([]),[p,b]=l.useState(""),[F,ge]=l.useState(null),[M,je]=l.useState([]),[J,Ce]=l.useState(1),[be,P]=l.useState(!1),[K,Z]=l.useState(""),[ee,se]=l.useState(!1),[A,Fe]=l.useState(null),[te,we]=l.useState(!0),[w,O]=l.useState(!1),[T,D]=l.useState(null),[v,R]=l.useState(!1),[L,U]=l.useState(null),[ve,_]=l.useState(!1),[Ee,Ne]=l.useState(""),[Be,Se]=l.useState(""),[ut,Ie]=l.useState("success"),[E,$]=l.useState(!1),[G,H]=l.useState(""),[oe,re]=l.useState(!0),[X,g]=l.useState(null),[W,Y]=l.useState(null),ke=()=>{switch(F){case"Dicatho":return"bg-dicatho";case"Pachinos":return"bg-pachinos";case"CEPAC":return"bg-cepac";default:return"bg-white"}},[N,j]=l.useState(null),[Me,B]=l.useState([]),[ae,S]=l.useState(!1),[I,k]=l.useState(null),[ne,Q]=l.useState(null);l.useEffect(()=>{(async()=>{try{await Promise.all([Pe(),x()]),le(M,p),h([])}catch(t){console.error("Error al inicializar datos:",t)}finally{we(!1)}})()},[]),l.useEffect(()=>{M.length>0&&le(M,p)},[M,p]);const Pe=async()=>{try{const e=await ss.get("/filemanager/hierarchy-company",{withCredentials:!0}),{hierarchy_level:t,company_name:o}=e.data;Ce(t),ge(o);const a=`public/${o}`;b(a)}catch(e){console.error("Error al obtener jerarquía y empresa:",e)}},x=async()=>{try{const e=await st(),t=a=>a.sort((r,i)=>r.name.localeCompare(i.name)).map(r=>(r.type==="folder"&&r.children&&(r.children=t(r.children)),r)),o=t(e);je([{name:"public",path:"public",type:"folder",children:o}])}catch(e){console.error("Error fetching files tree:",e),c("Error","Error al obtener el árbol de archivos.","error")}},le=(e,t)=>{var n,f;const o=t.split("/").filter(Boolean);let a={children:e};for(const u of o){const C=(n=a.children)==null?void 0:n.find(V=>V.name===u&&V.type==="folder");if(C)a=C;else{console.error("Ruta no encontrada en el árbol:",t),q([]);return}}let r=1;const i=((f=a.children)==null?void 0:f.map(u=>({id:r++,name:u.name,type:u.type,date:new Date,path:u.path})))||[];i.sort((u,C)=>u.name.localeCompare(C.name)),q(i)},Ae=e=>{var o;switch((o=e.split(".").pop())==null?void 0:o.toLowerCase()){case"aac":return s.jsx(Ys,{});case"ai":return s.jsx(Ws,{});case"bmp":return s.jsx(Xs,{});case"cs":return s.jsx(Gs,{});case"css":return s.jsx(_s,{});case"csv":return s.jsx(Ks,{});case"doc":return s.jsx(Js,{});case"docx":return s.jsx(qs,{});case"exe":return s.jsx(Vs,{});case"gif":return s.jsx(zs,{});case"heic":return s.jsx(Hs,{});case"html":return s.jsx($s,{});case"java":return s.jsx(Us,{});case"jpg":case"jpeg":return s.jsx(Ls,{});case"js":return s.jsx(Rs,{});case"json":return s.jsx(Ds,{});case"jsx":return s.jsx(Ts,{});case"key":return s.jsx(Os,{});case"m4p":return s.jsx(As,{});case"md":return s.jsx(Ps,{});case"mdx":return s.jsx(Ms,{});case"mov":return s.jsx(ks,{});case"mp3":return s.jsx(Is,{});case"mp4":return s.jsx(Ss,{});case"otf":return s.jsx(Bs,{});case"pdf":return s.jsx(Ns,{});case"php":return s.jsx(Es,{});case"png":return s.jsx(vs,{});case"ppt":return s.jsx(ws,{});case"pptx":return s.jsx(Fs,{});case"psd":return s.jsx(bs,{});case"py":return s.jsx(Cs,{});case"raw":return s.jsx(js,{});case"rb":return s.jsx(gs,{});case"sass":return s.jsx(hs,{});case"scss":return s.jsx(ys,{});case"sh":return s.jsx(xs,{});case"sql":return s.jsx(fs,{});case"svg":return s.jsx(us,{});case"tiff":return s.jsx(ds,{});case"tsx":return s.jsx(ms,{});case"ttf":return s.jsx(ps,{});case"txt":return s.jsx(is,{});case"wav":return s.jsx(cs,{});case"woff":return s.jsx(ls,{});case"xls":return s.jsx(ns,{});case"xlsx":return s.jsx(as,{});case"xml":return s.jsx(rs,{});case"yml":return s.jsx(os,{});default:return s.jsx(et,{})}},Oe=(e,t)=>{t.ctrlKey||t.metaKey?h(o=>o.includes(e)?o.filter(a=>a!==e):[...o,e]):h(o=>o.includes(e)&&o.length===1?[]:[e])},Te=e=>{var t;if(e.type==="folder")b(e.path);else{const o=(t=e.name.split(".").pop())==null?void 0:t.toLowerCase();o&&["pdf","docx","xlsx","xls","csv","txt","doc"].includes(o)?(Fe({url:`/filemanager/files/view?filename=${encodeURIComponent(e.name)}&path=${encodeURIComponent(p)}`,type:o}),se(!0)):c("Error","Tipo de archivo no soportado para visualización.","error")}},c=(e,t,o)=>{Ne(e),Se(t),Ie(o),_(!0)},De=()=>{P(!0)},Re=async()=>{if(K.trim()===""){c("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const e=await tt(K,p);c("Éxito","Carpeta creada exitosamente.","success"),await x(),Z(""),P(!1)}catch(e){e.response&&e.response.status===403?c("Error","No tienes permiso para crear carpetas.","error"):c("Error","Error al crear la carpeta.","error"),console.error(e)}},Le=async()=>{const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.onchange=async()=>{if(e.files&&e.files.length>0){const t=e.files.length;let o=0;g({total:t,completed:0});try{await ot(e.files,p),o=t,g({total:t,completed:o}),c("Éxito","Carpeta subida exitosamente.","success"),x()}catch{c("Error","Error al subir la carpeta.","error")}finally{g(null)}}},e.click()},Ue=async()=>{const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=async()=>{if(e.files&&e.files.length>0){const t=d.map(r=>r.name),a=Array.from(e.files).map(r=>r.name).filter(r=>t.includes(r));a.length>0?(B(a),Q(e.files),k("upload"),S(!0)):await ce(Array.from(e.files))}},e.click()},ce=async(e,t=!1)=>{var r,i;const o=e.length;let a=0;g({total:o,completed:0});try{for(const n of e)await rt(n,p,t),a+=1,g({total:o,completed:a});c("Éxito","Archivos subidos exitosamente.","success"),x()}catch(n){((i=(r=n.response)==null?void 0:r.data)==null?void 0:i.exception)==="Illuminate\\Http\\Exceptions\\PostTooLargeException"?c("Error","Uno de los archivos supera el límite de 10MB.","error"):c("Error","Error al subir uno o más archivos.","error")}finally{g(null)}},$e=async()=>{var e,t;if(m.length>0)try{for(const o of m){const a=d.find(r=>r.path===o);if(a){if(a.type==="file"){const r=await at(a.name,p),i=window.URL.createObjectURL(new Blob([r])),n=document.createElement("a");n.href=i,n.setAttribute("download",a.name),document.body.appendChild(n),n.click(),(e=n.parentNode)==null||e.removeChild(n)}else if(a.type==="folder"){const r=await nt(a.name,p),i=window.URL.createObjectURL(new Blob([r])),n=document.createElement("a");n.href=i,n.setAttribute("download",`${a.name}.zip`),document.body.appendChild(n),n.click(),(t=n.parentNode)==null||t.removeChild(n)}}}c("Éxito","Elemento(s) descargado(s) exitosamente.","success")}catch(o){o.response&&o.response.status===403?c("Error","No tienes permiso para descargar uno o más elementos.","error"):c("Error","Error al descargar uno o más elementos.","error"),console.error(o)}else c("Error","Por favor, selecciona al menos un elemento para descargar.","error")},He=async()=>{if(m.length>0&&window.confirm(`¿Estás seguro de que deseas eliminar ${m.length} elemento(s)?`)){const t=m.length;let o=0;Y({total:t,completed:0});try{for(const a of m){const r=d.find(i=>i.path===a);r&&(r.type==="file"?await lt(r.name,p):r.type==="folder"&&await ct(r.name,p),o+=1,Y({total:t,completed:o}))}c("Éxito","Elemento(s) eliminado(s) exitosamente.","success"),x()}catch{c("Error","Error al eliminar uno o más elementos.","error")}finally{Y(null)}}},ze=async()=>{if(m.length>0){const e=m.map(t=>{const o=d.find(a=>a.path===t);return o?{name:o.name,type:o.type}:null}).filter(Boolean);D({items:e,path:p}),O(!0)}},Ve=async()=>{if(T){const{items:e,path:t}=T,o=d.map(r=>r.name),a=e.filter(r=>o.includes(r.name));a.length>0?(B(a.map(r=>r.name)),k("copy"),S(!0)):await ie(e,t,p)}},ie=async(e,t,o,a=!1)=>{const r=e.length;let i=0;j({type:"copy",total:r,completed:i});try{await it(e,t,o,a),i=r,j({type:"copy",total:r,completed:i}),c("Éxito","Elemento(s) copiado(s) exitosamente.","success"),x(),O(!1),D(null),h([])}catch(n){n.response&&n.response.status===403?c("Error","No tienes permiso para copiar uno o más elementos.","error"):n.response&&n.response.data.error?c("Error",n.response.data.error,"error"):c("Error","Error al copiar uno o más elementos.","error"),console.error(n)}finally{j(null)}},pe=()=>{O(!1),D(null)},qe=async()=>{if(m.length>0){const e=m.map(t=>{const o=d.find(a=>a.path===t);return o?{name:o.name,type:o.type}:null}).filter(Boolean);U({items:e,path:p}),R(!0)}},Je=async()=>{if(L){const{items:e,path:t}=L,o=d.map(r=>r.name),a=e.filter(r=>o.includes(r.name));a.length>0?(B(a.map(r=>r.name)),k("move"),S(!0)):await me(e,t,p)}},me=async(e,t,o,a=!1)=>{const r=e.length;let i=0;j({type:"move",total:r,completed:i});try{await pt(e,t,o,a),i=r,j({type:"move",total:r,completed:i}),c("Éxito","Elemento(s) movido(s) exitosamente.","success"),x(),R(!1),U(null),h([])}catch(n){n.response&&n.response.status===403?c("Error","No tienes permiso para mover uno o más elementos.","error"):c("Error","Error al mover uno o más elementos.","error"),console.error(n)}finally{j(null)}},de=()=>{R(!1),U(null)},Ke=async()=>{if(I==="upload"&&ne)await ce(Array.from(ne),!0);else if(I==="copy"&&T){const{items:e,path:t}=T;await ie(e,t,p,!0)}else if(I==="move"&&L){const{items:e,path:t}=L;await me(e,t,p,!0)}S(!1),B([]),k(null),Q(null)},ue=()=>{S(!1),B([]),k(null),Q(null),I==="copy"?(O(!1),D(null)):I==="move"&&(R(!1),U(null))},_e=()=>{if(m.length===1){const e=m[0],t=d.find(o=>o.path===e);if(t){const o=t.type==="file"&&t.name.slice(0,t.name.lastIndexOf("."))||t.name;H(o),re(t.type==="file"),$(!0)}}else c("Error","Solo puedes renombrar un elemento a la vez.","error")},Ge=async e=>{if(e.preventDefault(),G.trim()===""){c("Error","El nombre del elemento no puede estar vacío.","error");return}const t=m[0],o=d.find(n=>n.path===t);if(!o){c("Error","Elemento seleccionado no encontrado.","error");return}const a=o.name;let r=G;if(o.type==="file"){const n=o.name.lastIndexOf("."),f=n!==-1?o.name.slice(n):"";r+=f}const i=o.type;try{const n={old_name:a,new_name:r,path:p,type:i};console.log("Renombrando:",n);const f=await mt(n);c("Éxito",f.message,"success"),x(),h([]),$(!1),H("")}catch(n){n.response&&n.response.status===403?c("Error","No tienes permiso para renombrar este elemento.","error"):n.response&&n.response.data.error?c("Error",n.response.data.error,"error"):c("Error","Error al renombrar el elemento.","error"),console.error(n)}},fe=()=>{$(!1),H(""),re(!0)},Xe=({criteria:e,order:t})=>{const o=[...d].sort((a,r)=>{var f,u;let i="",n="";if(e==="name")i=a.name.toLowerCase(),n=r.name.toLowerCase();else if(e==="type"){const C=a.type==="file"?((f=a.name.split(".").pop())==null?void 0:f.toLowerCase())||"":"0",V=r.type==="file"?((u=r.name.split(".").pop())==null?void 0:u.toLowerCase())||"":"0";if(i=C,n=V,a.type==="folder"&&r.type!=="folder")return t==="asc"?-1:1;if(a.type!=="folder"&&r.type==="folder")return t==="asc"?1:-1}return t==="asc"?i.localeCompare(n):n.localeCompare(i)});q(o)},z=l.useCallback(e=>{e.key==="Escape"&&(w&&pe(),v&&de(),E&&fe())},[w,v,E]);l.useEffect(()=>(w||v||E?window.addEventListener("keydown",z):window.removeEventListener("keydown",z),()=>{window.removeEventListener("keydown",z)}),[w,v,E,z]);const We=()=>{const e=p.split("/").filter(Boolean);if(e.length>1){e.pop();const t=e.join("/");b(t)}else b("public")},Ye=p!==`public/${F}`||J<=1;l.useMemo(()=>ke(),[F]);const xe={Dicatho:{backgroundClass:"bg-dicatho",textColor:"text-white"},Pachinos:{backgroundClass:"bg-pachinos",textColor:"text-white"},CEPAC:{backgroundClass:"bg-cepac",textColor:"text-white"},VSP:{backgroundClass:"bg-vsp",textColor:"text-white"},"La Penitencia":{backgroundClass:"bg-penitencia",textColor:"text-black"}},Qe=e=>{const t=e.split("/");return t.length>1?t[1]:null},Ze=e=>{const t=Qe(e.path);return t&&xe[t]?xe[t]:{backgroundClass:"bg-white",textColor:"text-black"}};return s.jsxs(s.Fragment,{children:[J!==null&&F&&!te&&s.jsx(dt,{currentPath:p,onNavigateTo:b,hierarchyLevel:J,companyName:F}),s.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[s.jsx(ts,{onCreateFolder:De,onUploadFolder:Le,onUploadFile:Ue,onDownloadFile:$e,onDelete:He,onCopy:ze,onRename:_e,onMove:qe,onSort:Xe,isItemSelected:m.length>0,onCopyHere:Ve,onCancelCopy:pe,isCopying:w,onMoveHere:Je,onCancelMove:de,isMoving:v,onBack:We,canGoBack:Ye,selectedItemsCount:m.length}),X&&s.jsx(y,{isOpen:!0,title:"Subiendo Archivos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:["Subiendo ",X.completed," de ",X.total," archivos."]})]})}),W&&s.jsx(y,{isOpen:!0,title:"Eliminando Archivos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:["Eliminando ",W.completed," de ",W.total," archivos."]})]})}),s.jsxs(y,{isOpen:be,title:"Crear Nueva Carpeta",onClose:()=>P(!1),children:[s.jsx("input",{type:"text",value:K,onChange:e=>Z(e.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{className:"btn btn-secondary",onClick:()=>P(!1),children:"Cancelar"}),s.jsx("button",{className:"btn btn-primary",onClick:Re,children:"Crear"})]})]}),ee&&A&&A.type&&s.jsx(Qs,{isOpen:ee,fileUrl:A.url,fileType:A.type,onClose:()=>se(!1)}),s.jsx(y,{isOpen:E,title:`Renombrar ${oe?"Archivo":"Carpeta"}`,onClose:()=>$(!1),children:s.jsxs("form",{onSubmit:Ge,children:[s.jsx("div",{className:"flex flex-col space-y-4",children:s.jsxs("div",{children:[s.jsx("label",{className:"label",children:s.jsxs("span",{className:"label-text",children:["Nombre ",oe?"de archivo":"de carpeta"]})}),s.jsx("input",{type:"text",value:G,onChange:e=>H(e.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]})}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{type:"button",className:"btn btn-secondary",onClick:fe,children:"Cancelar"}),s.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),s.jsx("div",{className:"p-4",children:te?s.jsx("div",{className:"flex justify-center items-center",children:s.jsx("span",{className:"loading loading-dots loading-lg text-primary"})}):d.length===0?s.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):s.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:d.map(e=>{const{backgroundClass:t,textColor:o}=Ze(e),a=m.includes(e.path);return s.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center relative ${a?"bg-blue-100":t} hover:bg-gray-200 transition-colors duration-200`,onClick:r=>Oe(e.path,r),onDoubleClick:()=>Te(e),children:[s.jsx("span",{className:`text-4xl ${a?"text-black":o}`,children:e.type==="folder"?s.jsx(Zs,{}):Ae(e.name)}),s.jsx("span",{className:`mt-2 text-center truncate w-full ${a?"text-black":o}`,children:e.name}),a&&s.jsx("span",{className:"absolute top-2 right-2 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center",children:"✓"})]},e.path)})})})]}),s.jsxs(y,{isOpen:ve,title:Ee,onClose:()=>_(!1),children:[s.jsx("p",{children:Be}),s.jsx("div",{className:"flex justify-end mt-4",children:s.jsx("button",{className:"btn",onClick:()=>_(!1),children:"Aceptar"})})]}),N&&s.jsx(y,{isOpen:!0,title:N.type==="copy"?"Copiando Elementos":"Moviendo Elementos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:[N.type==="copy"?"Copiando":"Moviendo"," ",N.completed," de ",N.total," elementos."]})]})}),ae&&s.jsxs(y,{isOpen:ae,title:"Conflicto de Elementos",onClose:ue,children:[s.jsx("p",{children:"Los siguientes elementos ya existen en el directorio destino:"}),s.jsx("ul",{className:"list-disc list-inside",children:Me.map(e=>s.jsx("li",{children:e},e))}),s.jsx("p",{children:"¿Deseas sobrescribirlos?"}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{className:"btn btn-secondary",onClick:ue,children:"Cancelar"}),s.jsx("button",{className:"btn btn-primary",onClick:Ke,children:"Sobrescribir"})]})]})]})};export{Nt as default};
