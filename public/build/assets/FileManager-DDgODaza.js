import{q as Ae,r as a,j as o,b as Oe}from"./app-rSw3n2GI.js";import{F as De,B as Te,a as Be}from"./Toolbar-DNWtk1zG.js";import H from"./Modal-QokKN0oO.js";import Le from"./FileManagerModal-BLUes_pQ.js";import{G as re}from"./index-CNJ3vcNY.js";import{getFilesTree as Ue,createFolder as $e,uploadDirectory as Ve,uploadFile as ze,downloadFile as He,downloadFolder as Pe,deleteFile as Ge,deleteFolder as qe,copyFile as _e,moveFile as Ke,renameFile as Je}from"./fileManagerApi-DFcaJlIN.js";import Qe from"./Breadcrumb-BIpnk0sk.js";import"./FileViewer-CLFZ4tPy.js";function We(u){return re({tag:"svg",attr:{viewBox:"0 0 384 512"},child:[{tag:"path",attr:{d:"M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"},child:[]}]})(u)}function Xe(u){return re({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M464 128H272l-64-64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48z"},child:[]}]})(u)}const lr=()=>{var W;const{auth:u}=Ae().props;(W=u.user)!=null&&W.permissions;const[n,f]=a.useState(null),[d,I]=a.useState([]),[i,h]=a.useState(""),[k,oe]=a.useState(null),[C,te]=a.useState([]),[R,se]=a.useState(1),[ae,E]=a.useState(!1),[A,P]=a.useState(""),[G,q]=a.useState(!1),[g,ne]=a.useState(null),[y,O]=a.useState(!1),[D,T]=a.useState(null),[x,B]=a.useState(!1),[L,U]=a.useState(null),[le,$]=a.useState(!1),[ie,ce]=a.useState(""),[de,pe]=a.useState(""),[Ye,me]=a.useState("success"),[v,N]=a.useState(!1),[j,F]=a.useState(""),[V,S]=a.useState(""),[b,z]=a.useState(!0);a.useEffect(()=>{(async()=>{try{await ue(),await p(),_(C,i),f(null)}catch(r){console.error("Error al inicializar datos:",r)}})()},[]),a.useEffect(()=>{C.length>0&&_(C,i)},[C,i]);const ue=async()=>{try{const e=await Oe.get("/filemanager/hierarchy-company",{withCredentials:!0}),{hierarchy_level:r,company_name:t}=e.data;se(r),oe(t);const l=`public/${t}`;h(l)}catch(e){console.error("Error al obtener jerarquía y empresa:",e)}},p=async()=>{try{const r={name:"public",path:"public",type:"folder",children:await Ue()};te([r])}catch(e){console.error("Error fetching files tree:",e),s("Error","Error al obtener el árbol de archivos.","error")}},_=(e,r)=>{var X,Y;const t=r.split("/").filter(Boolean);let l={children:e};for(const w of t){const Z=(X=l.children)==null?void 0:X.find(ee=>ee.name===w&&ee.type==="folder");if(Z)l=Z;else{console.error("Ruta no encontrada en el árbol:",r),I([]);return}}let m=1;const c=((Y=l.children)==null?void 0:Y.map(w=>({id:m++,name:w.name,type:w.type,date:new Date,path:w.path})))||[];I(c)},fe=e=>{var t;switch((t=e.split(".").pop())==null?void 0:t.toLowerCase()){case"aac":return o.jsx(Be,{});case"ai":return o.jsx(Te,{});default:return o.jsx(We,{})}},he=e=>{f(r=>r===e?null:e)},ye=e=>{var r;if(e.type==="folder")h(e.path);else{const t=(r=e.name.split(".").pop())==null?void 0:r.toLowerCase();t==="pdf"||t==="docx"||t==="xlsx"?(ne({url:`/filemanager/files/view?filename=${encodeURIComponent(e.name)}&path=${encodeURIComponent(i)}`,type:t}),q(!0)):s("Error","Tipo de archivo no soportado para visualización.","error")}},s=(e,r,t)=>{ce(e),pe(r),me(t),$(!0)},xe=()=>{E(!0)},ve=async()=>{if(A.trim()===""){s("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const e=await $e(A,i);s("Éxito","Carpeta creada exitosamente.","success"),p(),P(""),E(!1)}catch(e){e.response&&e.response.status===403?s("Error","No tienes permiso para crear carpetas.","error"):s("Error","Error al crear la carpeta.","error"),console.error(e)}},be=async()=>{const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.onchange=async()=>{if(e.files&&e.files.length>0)try{const r=await Ve(e.files,i);s("Éxito","Carpeta subida exitosamente.","success"),p()}catch(r){r.response&&r.response.status===403?s("Error","No tienes permiso para subir carpetas.","error"):s("Error","Error al subir la carpeta.","error"),console.error(r)}},e.click()},we=async()=>{const e=document.createElement("input");e.type="file",e.onchange=async()=>{if(e.files&&e.files[0])try{const r=await ze(e.files[0],i);s("Éxito","Archivo subido exitosamente.","success"),p()}catch(r){r.response&&r.response.status===403?s("Error","No tienes permiso para subir archivos.","error"):s("Error","Error al subir el archivo.","error"),console.error(r)}},e.click()},Ce=async()=>{var e,r;if(n){const t=d.find(l=>l.name===n);if(t){if(t.type==="file")try{const l=await He(t.name,i),m=window.URL.createObjectURL(new Blob([l])),c=document.createElement("a");c.href=m,c.setAttribute("download",t.name),document.body.appendChild(c),c.click(),(e=c.parentNode)==null||e.removeChild(c),s("Éxito","Archivo descargado exitosamente.","success")}catch(l){l.response&&l.response.status===403?s("Error","No tienes permiso para descargar archivos.","error"):s("Error","Error al descargar el archivo.","error"),console.error(l)}else if(t.type==="folder")try{const l=await Pe(t.name,i),m=window.URL.createObjectURL(new Blob([l])),c=document.createElement("a");c.href=m,c.setAttribute("download",`${t.name}.zip`),document.body.appendChild(c),c.click(),(r=c.parentNode)==null||r.removeChild(c),s("Éxito","Carpeta descargada exitosamente.","success")}catch(l){l.response&&l.response.status===403?s("Error","No tienes permiso para descargar carpetas.","error"):s("Error","Error al descargar la carpeta.","error"),console.error(l)}}}else s("Error","Por favor, selecciona un elemento para descargar.","error")},Ee=async()=>{if(n&&window.confirm(`¿Estás seguro de que deseas eliminar "${n}"?`))try{const r=d.find(t=>t.name===n);if(r){let t;r.type==="file"?t=await Ge(r.name,i):r.type==="folder"&&(t=await qe(r.name,i)),s("Éxito",t.message||"Elemento eliminado exitosamente.","success"),p(),f(null)}}catch(r){r.response&&r.response.status===403?s("Error","No tienes permiso para eliminar este elemento.","error"):s("Error","Error al eliminar el elemento.","error"),console.error(r)}},ge=async()=>{if(n){const e=d.find(r=>r.name===n);e&&e.type==="file"?(T({filename:e.name,path:i}),O(!0)):s("Error","Solo se pueden copiar archivos.","error")}},Ne=async()=>{if(D)try{const e=await _e(D.filename,D.path,i);s("Éxito","Archivo copiado exitosamente.","success"),p(),O(!1),T(null)}catch(e){e.response&&e.response.status===403?s("Error","No tienes permiso para copiar archivos.","error"):s("Error","Error al copiar el archivo.","error"),console.error(e)}},K=()=>{O(!1),T(null)},je=async()=>{if(n){const e=d.find(r=>r.name===n);e&&e.type==="file"?(U({filename:e.name,path:i}),B(!0)):s("Error","Solo se pueden mover archivos.","error")}},Fe=async()=>{if(L)try{const e=await Ke(L.filename,L.path,i);s("Éxito","Archivo movido exitosamente.","success"),p(),B(!1),U(null),f(null)}catch(e){e.response&&e.response.status===403?s("Error","No tienes permiso para mover archivos.","error"):s("Error","Error al mover el archivo.","error"),console.error(e)}},J=()=>{B(!1),U(null)},Se=()=>{if(n){const e=d.find(r=>r.name===n);if(e){const[r,t]=e.type==="file"?[n.slice(0,n.lastIndexOf("."))||n,n.slice(n.lastIndexOf(".")+1)]:[n,""];F(r),S(t),z(e.type==="file"),N(!0)}}},Me=async e=>{if(e.preventDefault(),j.trim()===""){s("Error","El nombre del elemento no puede estar vacío.","error");return}if(b&&V.trim()===""){s("Error","La extensión del archivo no puede estar vacía.","error");return}const r=b?`${j}.${V}`:j;try{if(n!=null){const t=await Je(n,r,i)}s("Éxito","Elemento renombrado exitosamente.","success"),p(),f(null),N(!1),F(""),S(""),z(!0)}catch(t){t.response&&t.response.status===403?s("Error","No tienes permiso para renombrar este elemento.","error"):s("Error","Error al renombrar el elemento.","error"),console.error(t)}},Q=()=>{N(!1),F(""),S(""),z(!0)},Ie=({criteria:e,order:r})=>{const t=[...d].sort((l,m)=>{let c=0;return e==="name"&&(c=l.name.localeCompare(m.name)),r==="asc"?c:-c});I(t)},M=a.useCallback(e=>{e.key==="Escape"&&(y&&K(),x&&J(),v&&Q())},[y,x,v]);a.useEffect(()=>(y||x||v?window.addEventListener("keydown",M):window.removeEventListener("keydown",M),()=>{window.removeEventListener("keydown",M)}),[y,x,v,M]);const ke=()=>{const e=i.split("/").filter(Boolean);if(e.length>1){e.pop();const r=e.join("/");h(r)}else h("public")},Re=i!==`public/${k}`||R<=1;return o.jsxs(o.Fragment,{children:[R!==null&&k&&o.jsx(Qe,{currentPath:i,onNavigateTo:h,hierarchyLevel:R,companyName:k}),o.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[o.jsx(De,{onCreateFolder:xe,onUploadFolder:be,onUploadFile:we,onDownloadFile:Ce,onDelete:Ee,onCopy:ge,onRename:Se,onMove:je,onSort:Ie,isItemSelected:n!==null,onCopyHere:Ne,onCancelCopy:K,isCopying:y,onMoveHere:Fe,onCancelMove:J,isMoving:x,onBack:ke,canGoBack:Re}),o.jsxs(H,{isOpen:ae,title:"Crear Nueva Carpeta",onClose:()=>E(!1),children:[o.jsx("input",{type:"text",value:A,onChange:e=>P(e.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),o.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[o.jsx("button",{className:"btn btn-secondary",onClick:()=>E(!1),children:"Cancelar"}),o.jsx("button",{className:"btn btn-primary",onClick:ve,children:"Crear"})]})]}),G&&g&&g.type&&o.jsx(Le,{isOpen:G,title:`Visualizando: ${n}`,fileUrl:g.url,fileType:g.type,onClose:()=>q(!1)}),o.jsx(H,{isOpen:v,title:`Renombrar ${b?"Archivo":"Carpeta"}`,onClose:()=>N(!1),children:o.jsxs("form",{onSubmit:Me,children:[o.jsxs("div",{className:"flex flex-col space-y-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"label",children:o.jsxs("span",{className:"label-text",children:["Nombre ",b?"de archivo":"de carpeta"]})}),o.jsx("input",{type:"text",value:j,onChange:e=>F(e.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]}),b&&o.jsxs("div",{children:[o.jsx("label",{className:"label",children:o.jsx("span",{className:"label-text",children:"Extensión del archivo"})}),o.jsx("input",{type:"text",value:V,onChange:e=>S(e.target.value),className:"input input-bordered w-full",placeholder:"Extensión (ej: txt, pdf)"})]})]}),o.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[o.jsx("button",{type:"button",className:"btn btn-secondary",onClick:Q,children:"Cancelar"}),o.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),o.jsx("div",{className:"p-4",children:d.length===0?o.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):o.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:d.map(e=>o.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center ${n===e.name?"bg-blue-100":"bg-white"} hover:bg-gray-200 transition-colors duration-200`,onClick:()=>he(e.name),onDoubleClick:()=>ye(e),children:[o.jsx("span",{className:"text-4xl",children:e.type==="folder"?o.jsx(Xe,{}):fe(e.name)}),o.jsx("span",{className:"mt-2 text-center truncate w-full",children:e.name})]},e.id))})})]}),o.jsxs(H,{isOpen:le,title:ie,onClose:()=>$(!1),children:[o.jsx("p",{children:de}),o.jsx("div",{className:"flex justify-end mt-4",children:o.jsx("button",{className:"btn",onClick:()=>$(!1),children:"Aceptar"})})]})]})};export{lr as default};
