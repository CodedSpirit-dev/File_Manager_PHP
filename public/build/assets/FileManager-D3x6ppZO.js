import{q as De,r as i,j as e,a as Le}from"./app-Zw6Pw8Qo.js";import{F as Ue,B as He,b as $e,c as ze,d as qe,e as Je,f as Ve,g as Ke,h as _e,i as Ge,j as Xe,k as We,l as Ye,m as Qe,n as Ze,o as es,p as ss,q as ts,s as rs,t as os,u as as,v as ns,x as ls,y as is,z as cs,A as ps,C as ds,D as ms,E as us,G as fs,H as ys,I as xs,J as hs,K as js,L as gs,N as Fs,O as vs,P as Cs,Q as bs,R as ws,S as Bs,T as Es,U as Ns,V as Ss,W as Is,X as Ms,Y as ks,Z as Ps,_ as As,a0 as Os}from"./Toolbar-CgN0PHkK.js";import F from"./Modal-Bcxlo08l.js";import Rs from"./FileViewerModal-CyeWN0ue.js";import{F as Ts,a as Ds}from"./FileViewer-BQroFPg2.js";import{getFilesTree as Ls,createFolder as Us,uploadDirectory as Hs,uploadFile as $s,downloadFile as zs,downloadFolder as qs,deleteFile as Js,deleteFolder as Vs,copyFiles as Ks,moveFile as _s,renameItem as Gs}from"./fileManagerApi-DvGB4WEz.js";import Xs from"./Breadcrumb-CW7xAjIa.js";import"./iconBase-BcH5n4ig.js";import"./index-Du4YH6Rk.js";import"./AuthProvider-GLPecKYc.js";import"./portal-BsOUIHmU.js";import"./use-server-handoff-complete-Dt2kEZhQ.js";const ct=()=>{var oe;const{auth:ae}=De().props;(oe=ae.user)!=null&&oe.permissions;const[d,x]=i.useState([]),[y,A]=i.useState([]),[p,v]=i.useState(""),[O,ne]=i.useState(null),[E,le]=i.useState([]),[R,ie]=i.useState(1),[ce,N]=i.useState(!1),[T,K]=i.useState(""),[_,G]=i.useState(!1),[S,pe]=i.useState(null),[X,de]=i.useState(!0),[C,D]=i.useState(!1),[W,L]=i.useState(null),[b,U]=i.useState(!1),[Y,H]=i.useState(null),[me,$]=i.useState(!1),[ue,fe]=i.useState(""),[ye,xe]=i.useState(""),[Ws,he]=i.useState("success"),[w,I]=i.useState(!1),[z,M]=i.useState(""),[Q,Z]=i.useState(!0),[q,h]=i.useState(null),[J,V]=i.useState(null),[B,j]=i.useState(null);i.useEffect(()=>{(async()=>{try{await Promise.all([je(),f()]),ee(E,p),x([])}catch(r){console.error("Error al inicializar datos:",r)}finally{de(!1)}})()},[]),i.useEffect(()=>{E.length>0&&ee(E,p)},[E,p]);const je=async()=>{try{const s=await Le.get("/filemanager/hierarchy-company",{withCredentials:!0}),{hierarchy_level:r,company_name:t}=s.data;ie(r),ne(t);const a=`public/${t}`;v(a)}catch(s){console.error("Error al obtener jerarquía y empresa:",s)}},f=async()=>{try{const s=await Ls(),r=a=>a.sort((o,c)=>o.name.localeCompare(c.name)).map(o=>(o.type==="folder"&&o.children&&(o.children=r(o.children)),o)),t=r(s);le([{name:"public",path:"public",type:"folder",children:t}])}catch(s){console.error("Error fetching files tree:",s),l("Error","Error al obtener el árbol de archivos.","error")}},ee=(s,r)=>{var n,u;const t=r.split("/").filter(Boolean);let a={children:s};for(const m of t){const g=(n=a.children)==null?void 0:n.find(P=>P.name===m&&P.type==="folder");if(g)a=g;else{console.error("Ruta no encontrada en el árbol:",r),A([]);return}}let o=1;const c=((u=a.children)==null?void 0:u.map(m=>({id:o++,name:m.name,type:m.type,date:new Date,path:m.path})))||[];c.sort((m,g)=>m.name.localeCompare(g.name)),A(c)},ge=s=>{var t;switch((t=s.split(".").pop())==null?void 0:t.toLowerCase()){case"aac":return e.jsx(Os,{});case"ai":return e.jsx(As,{});case"bmp":return e.jsx(Ps,{});case"cs":return e.jsx(ks,{});case"css":return e.jsx(Ms,{});case"csv":return e.jsx(Is,{});case"doc":return e.jsx(Ss,{});case"docx":return e.jsx(Ns,{});case"exe":return e.jsx(Es,{});case"gif":return e.jsx(Bs,{});case"heic":return e.jsx(ws,{});case"html":return e.jsx(bs,{});case"java":return e.jsx(Cs,{});case"jpg":case"jpeg":return e.jsx(vs,{});case"js":return e.jsx(Fs,{});case"json":return e.jsx(gs,{});case"jsx":return e.jsx(js,{});case"key":return e.jsx(hs,{});case"m4p":return e.jsx(xs,{});case"md":return e.jsx(ys,{});case"mdx":return e.jsx(fs,{});case"mov":return e.jsx(us,{});case"mp3":return e.jsx(ms,{});case"mp4":return e.jsx(ds,{});case"otf":return e.jsx(ps,{});case"pdf":return e.jsx(cs,{});case"php":return e.jsx(is,{});case"png":return e.jsx(ls,{});case"ppt":return e.jsx(ns,{});case"pptx":return e.jsx(as,{});case"psd":return e.jsx(os,{});case"py":return e.jsx(rs,{});case"raw":return e.jsx(ts,{});case"rb":return e.jsx(ss,{});case"sass":return e.jsx(es,{});case"scss":return e.jsx(Ze,{});case"sh":return e.jsx(Qe,{});case"sql":return e.jsx(Ye,{});case"svg":return e.jsx(We,{});case"tiff":return e.jsx(Xe,{});case"tsx":return e.jsx(Ge,{});case"ttf":return e.jsx(_e,{});case"txt":return e.jsx(Ke,{});case"wav":return e.jsx(Ve,{});case"woff":return e.jsx(Je,{});case"xls":return e.jsx(qe,{});case"xlsx":return e.jsx(ze,{});case"xml":return e.jsx($e,{});case"yml":return e.jsx(He,{});default:return e.jsx(Ds,{})}},Fe=(s,r)=>{r.ctrlKey||r.metaKey?x(t=>t.includes(s)?t.filter(a=>a!==s):[...t,s]):x(t=>t.includes(s)&&t.length===1?[]:[s])},ve=s=>{var r;if(s.type==="folder")v(s.path);else{const t=(r=s.name.split(".").pop())==null?void 0:r.toLowerCase();t&&["pdf","docx","xlsx","xls","csv","txt","doc"].includes(t)?(pe({url:`/filemanager/files/view?filename=${encodeURIComponent(s.name)}&path=${encodeURIComponent(p)}`,type:t}),G(!0)):l("Error","Tipo de archivo no soportado para visualización.","error")}},l=(s,r,t)=>{fe(s),xe(r),he(t),$(!0)},Ce=()=>{N(!0)},be=async()=>{if(T.trim()===""){l("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const s=await Us(T,p);l("Éxito","Carpeta creada exitosamente.","success"),await f(),K(""),N(!1)}catch(s){s.response&&s.response.status===403?l("Error","No tienes permiso para crear carpetas.","error"):l("Error","Error al crear la carpeta.","error"),console.error(s)}},we=async()=>{const s=document.createElement("input");s.type="file",s.webkitdirectory=!0,s.onchange=async()=>{if(s.files&&s.files.length>0){const r=s.files.length;let t=0;h({total:r,completed:0});try{await Hs(s.files,p),t=r,h({total:r,completed:t}),l("Éxito","Carpeta subida exitosamente.","success"),f()}catch{l("Error","Error al subir la carpeta.","error")}finally{h(null)}}},s.click()},Be=async()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.onchange=async()=>{var r,t;if(s.files&&s.files.length>0){const a=s.files.length;let o=0;h({total:a,completed:0});try{for(const c of Array.from(s.files))await $s(c,p),o+=1,h({total:a,completed:o});l("Éxito","Archivos subidos exitosamente.","success"),f()}catch(c){((t=(r=c.response)==null?void 0:r.data)==null?void 0:t.exception)==="Illuminate\\Http\\Exceptions\\PostTooLargeException"?l("Error","Uno de los archivos supera el límite de 10MB.","error"):l("Error","Error al subir uno o más archivos.","error")}finally{h(null)}}},s.click()},Ee=async()=>{var s,r;if(d.length>0)try{for(const t of d){const a=y.find(o=>o.path===t);if(a){if(a.type==="file"){const o=await zs(a.name,p),c=window.URL.createObjectURL(new Blob([o])),n=document.createElement("a");n.href=c,n.setAttribute("download",a.name),document.body.appendChild(n),n.click(),(s=n.parentNode)==null||s.removeChild(n)}else if(a.type==="folder"){const o=await qs(a.name,p),c=window.URL.createObjectURL(new Blob([o])),n=document.createElement("a");n.href=c,n.setAttribute("download",`${a.name}.zip`),document.body.appendChild(n),n.click(),(r=n.parentNode)==null||r.removeChild(n)}}}l("Éxito","Elemento(s) descargado(s) exitosamente.","success")}catch(t){t.response&&t.response.status===403?l("Error","No tienes permiso para descargar uno o más elementos.","error"):l("Error","Error al descargar uno o más elementos.","error"),console.error(t)}else l("Error","Por favor, selecciona al menos un elemento para descargar.","error")},Ne=async()=>{if(d.length>0&&window.confirm(`¿Estás seguro de que deseas eliminar ${d.length} elemento(s)?`)){const r=d.length;let t=0;V({total:r,completed:0});try{for(const a of d){const o=y.find(c=>c.path===a);o&&(o.type==="file"?await Js(o.name,p):o.type==="folder"&&await Vs(o.name,p),t+=1,V({total:r,completed:t}))}l("Éxito","Elemento(s) eliminado(s) exitosamente.","success"),f()}catch{l("Error","Error al eliminar uno o más elementos.","error")}finally{V(null)}}},Se=async()=>{d.length>0&&(L({filenames:d.map(s=>s.split("/").pop()||s),path:p}),D(!0))},Ie=async()=>{if(W){const{filenames:s,path:r}=W,t=s.length;let a=0;j({type:"copy",total:t,completed:a});try{await Ks(s,r,p),a=t,j({type:"copy",total:t,completed:a}),l("Éxito","Archivo(s) copiado(s) exitosamente.","success"),f(),D(!1),L(null),x([])}catch(o){o.response&&o.response.status===403?l("Error","No tienes permiso para copiar uno o más archivos.","error"):o.response&&o.response.data.error?l("Error",o.response.data.error,"error"):l("Error","Error al copiar uno o más archivos.","error"),console.error(o)}finally{j(null)}}},se=()=>{D(!1),L(null)},Me=async()=>{d.length>0&&(H({filenames:d.map(s=>s.split("/").pop()||s),path:p}),U(!0))},ke=async()=>{if(Y){const{filenames:s,path:r}=Y,t=s.length;let a=0;j({type:"move",total:t,completed:a});try{const o=s.map(async c=>{await _s(c,r,p),a+=1,j({type:"move",total:t,completed:a})});await Promise.all(o),l("Éxito","Archivo(s) movido(s) exitosamente.","success"),f(),U(!1),H(null),x([])}catch(o){o.response&&o.response.status===403?l("Error","No tienes permiso para mover uno o más archivos.","error"):l("Error","Error al mover uno o más archivos.","error"),console.error(o)}finally{j(null)}}},te=()=>{U(!1),H(null)},Pe=()=>{if(d.length===1){const s=d[0],r=y.find(t=>t.path===s);if(r){const t=r.type==="file"&&r.name.slice(0,r.name.lastIndexOf("."))||r.name;M(t),Z(r.type==="file"),I(!0)}}else l("Error","Solo puedes renombrar un elemento a la vez.","error")},Ae=async s=>{if(s.preventDefault(),z.trim()===""){l("Error","El nombre del elemento no puede estar vacío.","error");return}const r=d[0],t=y.find(n=>n.path===r);if(!t){l("Error","Elemento seleccionado no encontrado.","error");return}const a=t.name;let o=z;if(t.type==="file"){const n=t.name.lastIndexOf("."),u=n!==-1?t.name.slice(n):"";o+=u}const c=t.type;try{const n={old_name:a,new_name:o,path:p,type:c};console.log("Renombrando:",n);const u=await Gs(n);l("Éxito",u.message,"success"),f(),x([]),I(!1),M("")}catch(n){n.response&&n.response.status===403?l("Error","No tienes permiso para renombrar este elemento.","error"):n.response&&n.response.data.error?l("Error",n.response.data.error,"error"):l("Error","Error al renombrar el elemento.","error"),console.error(n)}},re=()=>{I(!1),M(""),Z(!0)},Oe=({criteria:s,order:r})=>{const t=[...y].sort((a,o)=>{var u,m;let c="",n="";if(s==="name")c=a.name.toLowerCase(),n=o.name.toLowerCase();else if(s==="type"){const g=a.type==="file"?((u=a.name.split(".").pop())==null?void 0:u.toLowerCase())||"":"0",P=o.type==="file"?((m=o.name.split(".").pop())==null?void 0:m.toLowerCase())||"":"0";if(c=g,n=P,a.type==="folder"&&o.type!=="folder")return r==="asc"?-1:1;if(a.type!=="folder"&&o.type==="folder")return r==="asc"?1:-1}return r==="asc"?c.localeCompare(n):n.localeCompare(c)});A(t)},k=i.useCallback(s=>{s.key==="Escape"&&(C&&se(),b&&te(),w&&re())},[C,b,w]);i.useEffect(()=>(C||b||w?window.addEventListener("keydown",k):window.removeEventListener("keydown",k),()=>{window.removeEventListener("keydown",k)}),[C,b,w,k]);const Re=()=>{const s=p.split("/").filter(Boolean);if(s.length>1){s.pop();const r=s.join("/");v(r)}else v("public")},Te=p!==`public/${O}`||R<=1;return e.jsxs(e.Fragment,{children:[R!==null&&O&&!X&&e.jsx(Xs,{currentPath:p,onNavigateTo:v,hierarchyLevel:R,companyName:O}),e.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[e.jsx(Ue,{onCreateFolder:Ce,onUploadFolder:we,onUploadFile:Be,onDownloadFile:Ee,onDelete:Ne,onCopy:Se,onRename:Pe,onMove:Me,onSort:Oe,isItemSelected:d.length>0,onCopyHere:Ie,onCancelCopy:se,isCopying:C,onMoveHere:ke,onCancelMove:te,isMoving:b,onBack:Re,canGoBack:Te,selectedItemsCount:d.length}),q&&e.jsx(F,{isOpen:!0,title:"Subiendo Archivos",onClose:()=>{},canClose:!1,children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),e.jsxs("p",{children:["Subiendo ",q.completed," de ",q.total," archivos."]})]})}),J&&e.jsx(F,{isOpen:!0,title:"Eliminando Archivos",onClose:()=>{},canClose:!1,children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),e.jsxs("p",{children:["Eliminando ",J.completed," de ",J.total," archivos."]})]})}),e.jsxs(F,{isOpen:ce,title:"Crear Nueva Carpeta",onClose:()=>N(!1),children:[e.jsx("input",{type:"text",value:T,onChange:s=>K(s.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),e.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>N(!1),children:"Cancelar"}),e.jsx("button",{className:"btn btn-primary",onClick:be,children:"Crear"})]})]}),_&&S&&S.type&&e.jsx(Rs,{isOpen:_,fileUrl:S.url,fileType:S.type,onClose:()=>G(!1)}),e.jsx(F,{isOpen:w,title:`Renombrar ${Q?"Archivo":"Carpeta"}`,onClose:()=>I(!1),children:e.jsxs("form",{onSubmit:Ae,children:[e.jsx("div",{className:"flex flex-col space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"label",children:e.jsxs("span",{className:"label-text",children:["Nombre ",Q?"de archivo":"de carpeta"]})}),e.jsx("input",{type:"text",value:z,onChange:s=>M(s.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]})}),e.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:re,children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),e.jsx("div",{className:"p-4",children:X?e.jsx("div",{className:"flex justify-center items-center",children:e.jsx("span",{className:"loading loading-dots loading-lg text-primary"})}):y.length===0?e.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):e.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:y.map(s=>e.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center relative ${d.includes(s.path)?"bg-blue-100":"bg-white"} hover:bg-gray-200 transition-colors duration-200`,onClick:r=>Fe(s.path,r),onDoubleClick:()=>ve(s),children:[e.jsx("span",{className:"text-4xl",children:s.type==="folder"?e.jsx(Ts,{}):ge(s.name)}),e.jsx("span",{className:"mt-2 text-center truncate w-full",children:s.name}),d.includes(s.path)&&e.jsx("span",{className:"absolute top-2 right-2 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center",children:"✓"})]},s.path))})})]}),e.jsxs(F,{isOpen:me,title:ue,onClose:()=>$(!1),children:[e.jsx("p",{children:ye}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{className:"btn",onClick:()=>$(!1),children:"Aceptar"})})]}),B&&e.jsx(F,{isOpen:!0,title:B.type==="copy"?"Copiando Archivos":"Moviendo Archivos",onClose:()=>{},canClose:!1,children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),e.jsxs("p",{children:[B.type==="copy"?"Copiando":"Moviendo"," ",B.completed," de ",B.total," archivos."]})]})})]})};export{ct as default};
