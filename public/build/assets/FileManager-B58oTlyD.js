import{q as ts,r as l,j as s,a as os}from"./app-Dich8IgY.js";import{F as as,B as rs,b as ns,c as ls,d as is,e as cs,f as ps,g as ms,h as ds,i as us,j as fs,k as xs,l as ys,m as hs,n as gs,o as js,p as Cs,q as bs,s as Fs,t as ws,u as vs,v as Es,x as Ns,y as Bs,z as Ss,A as Is,C as ks,D as Ms,E as Ps,G as As,H as Os,I as Ts,J as Ds,K as Rs,L as Ls,N as Us,O as $s,P as Hs,Q as zs,R as Vs,S as qs,T as Js,U as Gs,V as Ks,W as _s,X as Xs,Y as Ws,Z as Ys,_ as Qs,a0 as Zs}from"./Toolbar-B4YG7TYX.js";import y from"./Modal-BWr5tble.js";import et from"./FileViewerModal-BnLTRvmP.js";import{F as st,a as tt}from"./FileViewer-BaJia5by.js";import{getFilesTree as ot,createFolder as at,uploadDirectory as ge,uploadFile as rt,downloadFile as nt,downloadFolder as lt,deleteFile as it,deleteFolder as ct,copyItems as pt,moveItems as mt,renameItem as dt}from"./fileManagerApi-CvT-gtWD.js";import ut from"./Breadcrumb-CTrdeBbk.js";import"./iconBase-DRg5rT8v.js";import"./index-hnlsannx.js";import"./AuthProvider-ZtwJBpf8.js";import"./portal-D3HvhKdD.js";import"./use-server-handoff-complete-DGnsS0ko.js";const Bt=()=>{var ye;const{auth:je}=ts().props;(ye=je.user)!=null&&ye.permissions;const[m,h]=l.useState([]),[d,K]=l.useState([]),[p,E]=l.useState(""),[N,Ce]=l.useState(null),[P,be]=l.useState([]),[A,Fe]=l.useState(1),[we,O]=l.useState(!1),[_,ee]=l.useState(""),[se,te]=l.useState(!1),[T,ve]=l.useState(null),[oe,Ee]=l.useState(!0),[B,D]=l.useState(!1),[R,L]=l.useState(null),[S,U]=l.useState(!1),[$,H]=l.useState(null),[Ne,X]=l.useState(!1),[Be,Se]=l.useState(""),[Ie,ke]=l.useState(""),[ft,Me]=l.useState("success"),[I,z]=l.useState(!1),[W,V]=l.useState(""),[ae,re]=l.useState(!0),[Y,g]=l.useState(null),[Q,Z]=l.useState(null),Pe=()=>{switch(N){case"Dicatho":return"bg-dicatho";case"Pachinos":return"bg-pachinos";case"CEPAC":return"bg-cepac";default:return"bg-white"}},[k,j]=l.useState(null),[Ae,C]=l.useState([]),[ne,b]=l.useState(!1),[F,w]=l.useState(null),[q,J]=l.useState(null);l.useEffect(()=>{(async()=>{try{await Oe(),await x(),le(P,p),h([])}catch(t){console.error("Error al inicializar datos:",t)}finally{Ee(!1)}})()},[]),l.useEffect(()=>{P.length>0&&p&&le(P,p)},[P,p]);const Oe=async()=>{try{const e=await os.get("/filemanager/hierarchy-company",{withCredentials:!0}),{hierarchy_level:t,company_name:o}=e.data;Fe(t),Ce(o);const r=`public/${o}`;E(r)}catch(e){console.error("Error al obtener jerarquía y empresa:",e)}},x=async()=>{try{const e=await ot(),t=r=>r.sort((a,c)=>a.name.localeCompare(c.name)).map(a=>(a.type==="folder"&&a.children&&(a.children=t(a.children)),a)),o=t(e);be([{name:"public",path:"public",type:"folder",children:o}])}catch(e){console.error("Error fetching files tree:",e),i("Error","Error al obtener el árbol de archivos.","error")}},le=(e,t)=>{var u,M;const o=t.split("/").filter(Boolean);let r={children:e};for(const f of o){const v=(u=r.children)==null?void 0:u.find(he=>he.name===f&&he.type==="folder");if(v)r=v;else{console.error("Ruta no encontrada en el árbol:",t),K([]);return}}let a=1;const c=((M=r.children)==null?void 0:M.map(f=>({id:a++,name:f.name,type:f.type,date:new Date,path:f.path})))||[],n=A===0?c:c.filter(f=>f.name!=="SGI");n.sort((f,v)=>f.name.localeCompare(v.name)),K(n)},Te=e=>{var o;switch((o=e.split(".").pop())==null?void 0:o.toLowerCase()){case"aac":return s.jsx(Zs,{});case"ai":return s.jsx(Qs,{});case"bmp":return s.jsx(Ys,{});case"cs":return s.jsx(Ws,{});case"css":return s.jsx(Xs,{});case"csv":return s.jsx(_s,{});case"doc":return s.jsx(Ks,{});case"docx":return s.jsx(Gs,{});case"exe":return s.jsx(Js,{});case"gif":return s.jsx(qs,{});case"heic":return s.jsx(Vs,{});case"html":return s.jsx(zs,{});case"java":return s.jsx(Hs,{});case"jpg":case"jpeg":return s.jsx($s,{});case"js":return s.jsx(Us,{});case"json":return s.jsx(Ls,{});case"jsx":return s.jsx(Rs,{});case"key":return s.jsx(Ds,{});case"m4p":return s.jsx(Ts,{});case"md":return s.jsx(Os,{});case"mdx":return s.jsx(As,{});case"mov":return s.jsx(Ps,{});case"mp3":return s.jsx(Ms,{});case"mp4":return s.jsx(ks,{});case"otf":return s.jsx(Is,{});case"pdf":return s.jsx(Ss,{});case"php":return s.jsx(Bs,{});case"png":return s.jsx(Ns,{});case"ppt":return s.jsx(Es,{});case"pptx":return s.jsx(vs,{});case"psd":return s.jsx(ws,{});case"py":return s.jsx(Fs,{});case"raw":return s.jsx(bs,{});case"rb":return s.jsx(Cs,{});case"sass":return s.jsx(js,{});case"scss":return s.jsx(gs,{});case"sh":return s.jsx(hs,{});case"sql":return s.jsx(ys,{});case"svg":return s.jsx(xs,{});case"tiff":return s.jsx(fs,{});case"tsx":return s.jsx(us,{});case"ttf":return s.jsx(ds,{});case"txt":return s.jsx(ms,{});case"wav":return s.jsx(ps,{});case"woff":return s.jsx(cs,{});case"xls":return s.jsx(is,{});case"xlsx":return s.jsx(ls,{});case"xml":return s.jsx(ns,{});case"yml":return s.jsx(rs,{});default:return s.jsx(tt,{})}},De=(e,t)=>{t.ctrlKey||t.metaKey?h(o=>o.includes(e)?o.filter(r=>r!==e):[...o,e]):h(o=>o.includes(e)&&o.length===1?[]:[e])},Re=e=>{var t;if(e.type==="folder")E(e.path);else{const o=(t=e.name.split(".").pop())==null?void 0:t.toLowerCase();o&&["pdf","docx","xlsx","xls","csv","txt","doc"].includes(o)?(ve({url:`/filemanager/files/view?filename=${encodeURIComponent(e.name)}&path=${encodeURIComponent(p)}`,type:o}),te(!0)):i("Error","Tipo de archivo no soportado para visualización.","error")}},i=(e,t,o)=>{Se(e),ke(t),Me(o),X(!0)},Le=()=>{O(!0)},Ue=async()=>{if(_.trim()===""){i("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const e=await at(_,p);i("Éxito","Carpeta creada exitosamente.","success"),await x(),ee(""),O(!1)}catch(e){e.response&&e.response.status===403?i("Error","No tienes permiso para crear carpetas.","error"):i("Error","Error al crear la carpeta.","error"),console.error(e)}},$e=async()=>{const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.onchange=async()=>{if(e.files&&e.files.length>0){const t=e.files.length;let o=0;g({total:t,completed:0});try{const r=d.map(n=>n.name),c=Array.from(e.files).map(n=>{const u=n.webkitRelativePath.split("/");return u[u.length-1]}).filter(n=>r.includes(n));c.length>0?(C(c),J(e.files),w("uploadDirectory"),b(!0)):(await ge(e.files,p),o=t,g({total:t,completed:o}),i("Éxito","Carpeta subida exitosamente.","success"),x())}catch{i("Error","Error al subir la carpeta.","error")}finally{g(null)}}},e.click()},He=async()=>{const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=async()=>{if(e.files&&e.files.length>0){const t=d.map(a=>a.name),r=Array.from(e.files).map(a=>a.name).filter(a=>t.includes(a));r.length>0?(C(r),J(e.files),w("upload"),b(!0)):await ie(Array.from(e.files))}},e.click()},ie=async(e,t=!1)=>{var a,c;const o=e.length;let r=0;g({total:o,completed:0});try{for(const n of e)await rt(n,p,t),r+=1,g({total:o,completed:r});i("Éxito","Archivos subidos exitosamente.","success"),x()}catch(n){((c=(a=n.response)==null?void 0:a.data)==null?void 0:c.exception)==="Illuminate\\Http\\Exceptions\\PostTooLargeException"?i("Error","Uno de los archivos supera el límite de 10MB.","error"):i("Error","Error al subir uno o más archivos.","error")}finally{g(null)}},ze=async()=>{var e,t;if(m.length>0)try{for(const o of m){const r=d.find(a=>a.path===o);if(r){if(r.type==="file"){const a=await nt(r.name,p),c=window.URL.createObjectURL(new Blob([a])),n=document.createElement("a");n.href=c,n.setAttribute("download",r.name),document.body.appendChild(n),n.click(),(e=n.parentNode)==null||e.removeChild(n)}else if(r.type==="folder"){const a=await lt(r.name,p),c=window.URL.createObjectURL(new Blob([a])),n=document.createElement("a");n.href=c,n.setAttribute("download",`${r.name}.zip`),document.body.appendChild(n),n.click(),(t=n.parentNode)==null||t.removeChild(n)}}}i("Éxito","Elemento(s) descargado(s) exitosamente.","success")}catch(o){o.response&&o.response.status===403?i("Error","No tienes permiso para descargar uno o más elementos.","error"):i("Error","Error al descargar uno o más elementos.","error"),console.error(o)}else i("Error","Por favor, selecciona al menos un elemento para descargar.","error")},Ve=async()=>{if(m.length>0&&window.confirm(`¿Estás seguro de que deseas eliminar ${m.length} elemento(s)?`)){const t=m.length;let o=0;Z({total:t,completed:0});try{for(const r of m){const a=d.find(c=>c.path===r);a&&(a.type==="file"?await it(a.name,p):a.type==="folder"&&await ct(a.name,p),o+=1,Z({total:t,completed:o}))}i("Éxito","Elemento(s) eliminado(s) exitosamente.","success"),x()}catch{i("Error","Error al eliminar uno o más elementos.","error")}finally{Z(null)}}},qe=async()=>{if(m.length>0){const e=m.map(t=>{const o=d.find(r=>r.path===t);return o?{name:o.name,type:o.type}:null}).filter(Boolean);L({items:e,path:p}),D(!0)}},Je=async()=>{if(R){const{items:e,path:t}=R,o=d.map(a=>a.name),r=e.filter(a=>o.includes(a.name));r.length>0?(C(r.map(a=>a.name)),w("copy"),b(!0)):await ce(e,t,p)}},ce=async(e,t,o,r=!1)=>{const a=e.length;let c=0;j({type:"copy",total:a,completed:c});try{await pt(e,t,o,r),c=a,j({type:"copy",total:a,completed:c}),i("Éxito","Elemento(s) copiado(s) exitosamente.","success"),x(),D(!1),L(null),h([])}catch(n){n.response&&n.response.status===403?i("Error","No tienes permiso para copiar uno o más elementos.","error"):n.response&&n.response.data.error?i("Error",n.response.data.error,"error"):i("Error","Error al copiar uno o más elementos.","error"),console.error(n)}finally{j(null)}},pe=()=>{D(!1),L(null)},Ge=async()=>{if(m.length>0){const e=m.map(t=>{const o=d.find(r=>r.path===t);return o?{name:o.name,type:o.type}:null}).filter(Boolean);H({items:e,path:p}),U(!0)}},Ke=async()=>{if($){const{items:e,path:t}=$,o=d.map(a=>a.name),r=e.filter(a=>o.includes(a.name));r.length>0?(C(r.map(a=>a.name)),w("move"),b(!0)):await me(e,t,p)}},me=async(e,t,o,r=!1)=>{const a=e.length;let c=0;j({type:"move",total:a,completed:c});try{await mt(e,t,o,r),c=a,j({type:"move",total:a,completed:c}),i("Éxito","Elemento(s) movido(s) exitosamente.","success"),x(),U(!1),H(null),h([])}catch(n){n.response&&n.response.status===403?i("Error","No tienes permiso para mover uno o más elementos.","error"):i("Error","Error al mover uno o más elementos.","error"),console.error(n)}finally{j(null)}},de=()=>{U(!1),H(null)},_e=async()=>{if(F==="upload"&&q)await ie(Array.from(q),!0);else if(F==="uploadDirectory"&&q)await ge(q,p,!0);else if(F==="copy"&&R){const{items:e,path:t}=R;await ce(e,t,p,!0)}else if(F==="move"&&$){const{items:e,path:t}=$;await me(e,t,p,!0)}b(!1),C([]),w(null),J(null)},ue=()=>{b(!1),C([]),w(null),J(null),F==="copy"?(D(!1),L(null)):F==="move"&&(U(!1),H(null))},Xe=()=>{if(m.length===1){const e=m[0],t=d.find(o=>o.path===e);if(t){const o=t.type==="file"&&t.name.slice(0,t.name.lastIndexOf("."))||t.name;V(o),re(t.type==="file"),z(!0)}}else i("Error","Solo puedes renombrar un elemento a la vez.","error")},We=async e=>{if(e.preventDefault(),W.trim()===""){i("Error","El nombre del elemento no puede estar vacío.","error");return}const t=m[0],o=d.find(n=>n.path===t);if(!o){i("Error","Elemento seleccionado no encontrado.","error");return}const r=o.name;let a=W;if(o.type==="file"){const n=o.name.lastIndexOf("."),u=n!==-1?o.name.slice(n):"";a+=u}const c=o.type;try{const n={old_name:r,new_name:a,path:p,type:c};console.log("Renombrando:",n);const u=await dt(n);i("Éxito",u.message,"success"),x(),h([]),z(!1),V("")}catch(n){n.response&&n.response.status===403?i("Error","No tienes permiso para renombrar este elemento.","error"):n.response&&n.response.data.error?i("Error",n.response.data.error,"error"):i("Error","Error al renombrar el elemento.","error"),console.error(n)}},fe=()=>{z(!1),V(""),re(!0)},Ye=({criteria:e,order:t})=>{const o=[...d].sort((r,a)=>{var u,M;let c="",n="";if(e==="name")c=r.name.toLowerCase(),n=a.name.toLowerCase();else if(e==="type"){const f=r.type==="file"?((u=r.name.split(".").pop())==null?void 0:u.toLowerCase())||"":"0",v=a.type==="file"?((M=a.name.split(".").pop())==null?void 0:M.toLowerCase())||"":"0";if(c=f,n=v,r.type==="folder"&&a.type!=="folder")return t==="asc"?-1:1;if(r.type!=="folder"&&a.type==="folder")return t==="asc"?1:-1}return t==="asc"?c.localeCompare(n):n.localeCompare(c)});K(o)},G=l.useCallback(e=>{e.key==="Escape"&&(B&&pe(),S&&de(),I&&fe())},[B,S,I]);l.useEffect(()=>(B||S||I?window.addEventListener("keydown",G):window.removeEventListener("keydown",G),()=>{window.removeEventListener("keydown",G)}),[B,S,I,G]);const Qe=()=>{const e=p.split("/").filter(Boolean);if(e.length>1){e.pop();const t=e.join("/");E(t)}else E("public")},Ze=p!==`public/${N}`||A<=1;l.useMemo(()=>Pe(),[N]);const xe={Dicatho:{backgroundClass:"bg-dicatho",textColor:"text-white"},Pachinos:{backgroundClass:"bg-pachinos",textColor:"text-white"},CEPAC:{backgroundClass:"bg-cepac",textColor:"text-white"},VSP:{backgroundClass:"bg-vsp",textColor:"text-white"},"La Penitencia":{backgroundClass:"bg-penitencia",textColor:"text-black"}},es=e=>{const t=e.split("/");return t.length>1?t[1]:null},ss=e=>{const t=es(e.path);return t&&xe[t]?xe[t]:{backgroundClass:"bg-white",textColor:"text-black"}};return s.jsxs(s.Fragment,{children:[A!==null&&N&&!oe&&s.jsx(ut,{currentPath:p,onNavigateTo:E,hierarchyLevel:A,companyName:N}),s.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[s.jsx(as,{onCreateFolder:Le,onUploadFolder:$e,onUploadFile:He,onDownloadFile:ze,onDelete:Ve,onCopy:qe,onRename:Xe,onMove:Ge,onSort:Ye,isItemSelected:m.length>0,onCopyHere:Je,onCancelCopy:pe,isCopying:B,onMoveHere:Ke,onCancelMove:de,isMoving:S,onBack:Qe,canGoBack:Ze,selectedItemsCount:m.length}),Y&&s.jsx(y,{isOpen:!0,title:"Subiendo Archivos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:["Subiendo ",Y.completed," de ",Y.total," archivos."]})]})}),Q&&s.jsx(y,{isOpen:!0,title:"Eliminando Archivos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:["Eliminando ",Q.completed," de ",Q.total," archivos."]})]})}),s.jsxs(y,{isOpen:we,title:"Crear Nueva Carpeta",onClose:()=>O(!1),children:[s.jsx("input",{type:"text",value:_,onChange:e=>ee(e.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{className:"btn btn-secondary",onClick:()=>O(!1),children:"Cancelar"}),s.jsx("button",{className:"btn btn-primary",onClick:Ue,children:"Crear"})]})]}),se&&T&&T.type&&s.jsx(et,{isOpen:se,fileUrl:T.url,fileType:T.type,onClose:()=>te(!1)}),s.jsx(y,{isOpen:I,title:`Renombrar ${ae?"Archivo":"Carpeta"}`,onClose:()=>z(!1),children:s.jsxs("form",{onSubmit:We,children:[s.jsx("div",{className:"flex flex-col space-y-4",children:s.jsxs("div",{children:[s.jsx("label",{className:"label",children:s.jsxs("span",{className:"label-text",children:["Nombre ",ae?"de archivo":"de carpeta"]})}),s.jsx("input",{type:"text",value:W,onChange:e=>V(e.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]})}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{type:"button",className:"btn btn-secondary",onClick:fe,children:"Cancelar"}),s.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),s.jsx("div",{className:"p-4",children:oe?s.jsx("div",{className:"flex justify-center items-center",children:s.jsx("span",{className:"loading loading-dots loading-lg text-primary"})}):d.length===0?s.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):s.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:d.map(e=>{const{backgroundClass:t,textColor:o}=ss(e),r=m.includes(e.path);return s.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center relative ${r?"bg-blue-100":t} hover:bg-gray-200 transition-colors duration-200`,onClick:a=>De(e.path,a),onDoubleClick:()=>Re(e),children:[s.jsx("span",{className:`text-4xl ${r?"text-black":o}`,children:e.type==="folder"?s.jsx(st,{}):Te(e.name)}),s.jsx("span",{className:`mt-2 text-center truncate w-full ${r?"text-black":o}`,children:e.name}),r&&s.jsx("span",{className:"absolute top-2 right-2 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center",children:"✓"})]},e.path)})})})]}),s.jsxs(y,{isOpen:Ne,title:Be,onClose:()=>X(!1),children:[s.jsx("p",{children:Ie}),s.jsx("div",{className:"flex justify-end mt-4",children:s.jsx("button",{className:"btn",onClick:()=>X(!1),children:"Aceptar"})})]}),k&&s.jsx(y,{isOpen:!0,title:k.type==="copy"?"Copiando Elementos":"Moviendo Elementos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:[k.type==="copy"?"Copiando":"Moviendo"," ",k.completed," de ",k.total," elementos."]})]})}),ne&&s.jsxs(y,{isOpen:ne,title:"Conflicto de Elementos",onClose:ue,children:[s.jsx("p",{children:"Los siguientes elementos ya existen en el directorio destino:"}),s.jsx("ul",{className:"list-disc list-inside",children:Ae.map(e=>s.jsx("li",{children:e},e))}),s.jsx("p",{children:"¿Deseas sobrescribirlos?"}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{className:"btn btn-secondary",onClick:ue,children:"Cancelar"}),s.jsx("button",{className:"btn btn-primary",onClick:_e,children:"Sobrescribir"})]})]})]})};export{Bt as default};
