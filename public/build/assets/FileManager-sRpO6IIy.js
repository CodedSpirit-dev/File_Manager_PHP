import{q as He,r as c,j as e,a as ze}from"./app-5APUolP4.js";import{F as Ve,B as qe,b as Je,c as Ke,d as _e,e as Ge,f as Xe,g as We,h as Ye,i as Qe,j as Ze,k as es,l as ss,m as ts,n as rs,o as os,p as as,q as ns,s as ls,t as cs,u as is,v as ps,x as ds,y as ms,z as us,A as fs,C as xs,D as hs,E as ys,G as gs,H as js,I as Cs,J as Fs,K as bs,L as vs,N as ws,O as Es,P as Bs,Q as Ns,R as Ss,S as ks,T as Is,U as Ms,V as Ps,W as As,X as Ds,Y as Os,Z as Rs,_ as Ts,a0 as Ls}from"./Toolbar-CroFZM51.js";import C from"./Modal-DS0-7RFA.js";import Us from"./FileViewerModal-B9d25qIv.js";import{F as $s,a as Hs}from"./FileViewer-C9A8Upiy.js";import{getFilesTree as zs,createFolder as Vs,uploadDirectory as qs,uploadFile as Js,downloadFile as Ks,downloadFolder as _s,deleteFile as Gs,deleteFolder as Xs,copyFiles as Ws,moveFile as Ys,renameItem as Qs}from"./fileManagerApi-Je3vBvb6.js";import Zs from"./Breadcrumb-CkV61jjl.js";import"./iconBase-s_asjWEy.js";import"./index-B7djVxPp.js";import"./AuthProvider-DkXAx5pr.js";import"./portal-B_UsM9Tp.js";import"./use-server-handoff-complete-BxRDgI3R.js";const ut=()=>{var ae;const{auth:ne}=He().props;(ae=ne.user)!=null&&ae.permissions;const[d,h]=c.useState([]),[x,D]=c.useState([]),[p,F]=c.useState(""),[b,le]=c.useState(null),[N,ce]=c.useState([]),[O,ie]=c.useState(1),[pe,S]=c.useState(!1),[R,K]=c.useState(""),[_,G]=c.useState(!1),[k,de]=c.useState(null),[X,me]=c.useState(!0),[v,T]=c.useState(!1),[W,L]=c.useState(null),[w,U]=c.useState(!1),[Y,$]=c.useState(null),[ue,H]=c.useState(!1),[fe,xe]=c.useState(""),[he,ye]=c.useState(""),[et,ge]=c.useState("success"),[E,I]=c.useState(!1),[z,M]=c.useState(""),[Q,Z]=c.useState(!0),[V,y]=c.useState(null),[q,J]=c.useState(null),je=()=>{switch(b){case"Dicatho":return"bg-dicatho";case"Pachinos":return"bg-pachinos";case"CEPAC":return"bg-cepac";default:return"bg-white"}},[B,g]=c.useState(null);c.useEffect(()=>{(async()=>{try{await Promise.all([Ce(),f()]),ee(N,p),h([])}catch(t){console.error("Error al inicializar datos:",t)}finally{me(!1)}})()},[]),c.useEffect(()=>{N.length>0&&ee(N,p)},[N,p]);const Ce=async()=>{try{const s=await ze.get("/filemanager/hierarchy-company",{withCredentials:!0}),{hierarchy_level:t,company_name:r}=s.data;ie(t),le(r);const a=`public/${r}`;F(a)}catch(s){console.error("Error al obtener jerarquía y empresa:",s)}},f=async()=>{try{const s=await zs(),t=a=>a.sort((o,i)=>o.name.localeCompare(i.name)).map(o=>(o.type==="folder"&&o.children&&(o.children=t(o.children)),o)),r=t(s);ce([{name:"public",path:"public",type:"folder",children:r}])}catch(s){console.error("Error fetching files tree:",s),l("Error","Error al obtener el árbol de archivos.","error")}},ee=(s,t)=>{var n,u;const r=t.split("/").filter(Boolean);let a={children:s};for(const m of r){const j=(n=a.children)==null?void 0:n.find(A=>A.name===m&&A.type==="folder");if(j)a=j;else{console.error("Ruta no encontrada en el árbol:",t),D([]);return}}let o=1;const i=((u=a.children)==null?void 0:u.map(m=>({id:o++,name:m.name,type:m.type,date:new Date,path:m.path})))||[];i.sort((m,j)=>m.name.localeCompare(j.name)),D(i)},Fe=s=>{var r;switch((r=s.split(".").pop())==null?void 0:r.toLowerCase()){case"aac":return e.jsx(Ls,{});case"ai":return e.jsx(Ts,{});case"bmp":return e.jsx(Rs,{});case"cs":return e.jsx(Os,{});case"css":return e.jsx(Ds,{});case"csv":return e.jsx(As,{});case"doc":return e.jsx(Ps,{});case"docx":return e.jsx(Ms,{});case"exe":return e.jsx(Is,{});case"gif":return e.jsx(ks,{});case"heic":return e.jsx(Ss,{});case"html":return e.jsx(Ns,{});case"java":return e.jsx(Bs,{});case"jpg":case"jpeg":return e.jsx(Es,{});case"js":return e.jsx(ws,{});case"json":return e.jsx(vs,{});case"jsx":return e.jsx(bs,{});case"key":return e.jsx(Fs,{});case"m4p":return e.jsx(Cs,{});case"md":return e.jsx(js,{});case"mdx":return e.jsx(gs,{});case"mov":return e.jsx(ys,{});case"mp3":return e.jsx(hs,{});case"mp4":return e.jsx(xs,{});case"otf":return e.jsx(fs,{});case"pdf":return e.jsx(us,{});case"php":return e.jsx(ms,{});case"png":return e.jsx(ds,{});case"ppt":return e.jsx(ps,{});case"pptx":return e.jsx(is,{});case"psd":return e.jsx(cs,{});case"py":return e.jsx(ls,{});case"raw":return e.jsx(ns,{});case"rb":return e.jsx(as,{});case"sass":return e.jsx(os,{});case"scss":return e.jsx(rs,{});case"sh":return e.jsx(ts,{});case"sql":return e.jsx(ss,{});case"svg":return e.jsx(es,{});case"tiff":return e.jsx(Ze,{});case"tsx":return e.jsx(Qe,{});case"ttf":return e.jsx(Ye,{});case"txt":return e.jsx(We,{});case"wav":return e.jsx(Xe,{});case"woff":return e.jsx(Ge,{});case"xls":return e.jsx(_e,{});case"xlsx":return e.jsx(Ke,{});case"xml":return e.jsx(Je,{});case"yml":return e.jsx(qe,{});default:return e.jsx(Hs,{})}},be=(s,t)=>{t.ctrlKey||t.metaKey?h(r=>r.includes(s)?r.filter(a=>a!==s):[...r,s]):h(r=>r.includes(s)&&r.length===1?[]:[s])},ve=s=>{var t;if(s.type==="folder")F(s.path);else{const r=(t=s.name.split(".").pop())==null?void 0:t.toLowerCase();r&&["pdf","docx","xlsx","xls","csv","txt","doc"].includes(r)?(de({url:`/filemanager/files/view?filename=${encodeURIComponent(s.name)}&path=${encodeURIComponent(p)}`,type:r}),G(!0)):l("Error","Tipo de archivo no soportado para visualización.","error")}},l=(s,t,r)=>{xe(s),ye(t),ge(r),H(!0)},we=()=>{S(!0)},Ee=async()=>{if(R.trim()===""){l("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const s=await Vs(R,p);l("Éxito","Carpeta creada exitosamente.","success"),await f(),K(""),S(!1)}catch(s){s.response&&s.response.status===403?l("Error","No tienes permiso para crear carpetas.","error"):l("Error","Error al crear la carpeta.","error"),console.error(s)}},Be=async()=>{const s=document.createElement("input");s.type="file",s.webkitdirectory=!0,s.onchange=async()=>{if(s.files&&s.files.length>0){const t=s.files.length;let r=0;y({total:t,completed:0});try{await qs(s.files,p),r=t,y({total:t,completed:r}),l("Éxito","Carpeta subida exitosamente.","success"),f()}catch{l("Error","Error al subir la carpeta.","error")}finally{y(null)}}},s.click()},Ne=async()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.onchange=async()=>{var t,r;if(s.files&&s.files.length>0){const a=s.files.length;let o=0;y({total:a,completed:0});try{for(const i of Array.from(s.files))await Js(i,p),o+=1,y({total:a,completed:o});l("Éxito","Archivos subidos exitosamente.","success"),f()}catch(i){((r=(t=i.response)==null?void 0:t.data)==null?void 0:r.exception)==="Illuminate\\Http\\Exceptions\\PostTooLargeException"?l("Error","Uno de los archivos supera el límite de 10MB.","error"):l("Error","Error al subir uno o más archivos.","error")}finally{y(null)}}},s.click()},Se=async()=>{var s,t;if(d.length>0)try{for(const r of d){const a=x.find(o=>o.path===r);if(a){if(a.type==="file"){const o=await Ks(a.name,p),i=window.URL.createObjectURL(new Blob([o])),n=document.createElement("a");n.href=i,n.setAttribute("download",a.name),document.body.appendChild(n),n.click(),(s=n.parentNode)==null||s.removeChild(n)}else if(a.type==="folder"){const o=await _s(a.name,p),i=window.URL.createObjectURL(new Blob([o])),n=document.createElement("a");n.href=i,n.setAttribute("download",`${a.name}.zip`),document.body.appendChild(n),n.click(),(t=n.parentNode)==null||t.removeChild(n)}}}l("Éxito","Elemento(s) descargado(s) exitosamente.","success")}catch(r){r.response&&r.response.status===403?l("Error","No tienes permiso para descargar uno o más elementos.","error"):l("Error","Error al descargar uno o más elementos.","error"),console.error(r)}else l("Error","Por favor, selecciona al menos un elemento para descargar.","error")},ke=async()=>{if(d.length>0&&window.confirm(`¿Estás seguro de que deseas eliminar ${d.length} elemento(s)?`)){const t=d.length;let r=0;J({total:t,completed:0});try{for(const a of d){const o=x.find(i=>i.path===a);o&&(o.type==="file"?await Gs(o.name,p):o.type==="folder"&&await Xs(o.name,p),r+=1,J({total:t,completed:r}))}l("Éxito","Elemento(s) eliminado(s) exitosamente.","success"),f()}catch{l("Error","Error al eliminar uno o más elementos.","error")}finally{J(null)}}},Ie=async()=>{d.length>0&&(L({filenames:d.map(s=>s.split("/").pop()||s),path:p}),T(!0))},Me=async()=>{if(W){const{filenames:s,path:t}=W,r=s.length;let a=0;g({type:"copy",total:r,completed:a});try{await Ws(s,t,p),a=r,g({type:"copy",total:r,completed:a}),l("Éxito","Archivo(s) copiado(s) exitosamente.","success"),f(),T(!1),L(null),h([])}catch(o){o.response&&o.response.status===403?l("Error","No tienes permiso para copiar uno o más archivos.","error"):o.response&&o.response.data.error?l("Error",o.response.data.error,"error"):l("Error","Error al copiar uno o más archivos.","error"),console.error(o)}finally{g(null)}}},se=()=>{T(!1),L(null)},Pe=async()=>{d.length>0&&($({filenames:d.map(s=>s.split("/").pop()||s),path:p}),U(!0))},Ae=async()=>{if(Y){const{filenames:s,path:t}=Y,r=s.length;let a=0;g({type:"move",total:r,completed:a});try{const o=s.map(async i=>{await Ys(i,t,p),a+=1,g({type:"move",total:r,completed:a})});await Promise.all(o),l("Éxito","Archivo(s) movido(s) exitosamente.","success"),f(),U(!1),$(null),h([])}catch(o){o.response&&o.response.status===403?l("Error","No tienes permiso para mover uno o más archivos.","error"):l("Error","Error al mover uno o más archivos.","error"),console.error(o)}finally{g(null)}}},te=()=>{U(!1),$(null)},De=()=>{if(d.length===1){const s=d[0],t=x.find(r=>r.path===s);if(t){const r=t.type==="file"&&t.name.slice(0,t.name.lastIndexOf("."))||t.name;M(r),Z(t.type==="file"),I(!0)}}else l("Error","Solo puedes renombrar un elemento a la vez.","error")},Oe=async s=>{if(s.preventDefault(),z.trim()===""){l("Error","El nombre del elemento no puede estar vacío.","error");return}const t=d[0],r=x.find(n=>n.path===t);if(!r){l("Error","Elemento seleccionado no encontrado.","error");return}const a=r.name;let o=z;if(r.type==="file"){const n=r.name.lastIndexOf("."),u=n!==-1?r.name.slice(n):"";o+=u}const i=r.type;try{const n={old_name:a,new_name:o,path:p,type:i};console.log("Renombrando:",n);const u=await Qs(n);l("Éxito",u.message,"success"),f(),h([]),I(!1),M("")}catch(n){n.response&&n.response.status===403?l("Error","No tienes permiso para renombrar este elemento.","error"):n.response&&n.response.data.error?l("Error",n.response.data.error,"error"):l("Error","Error al renombrar el elemento.","error"),console.error(n)}},re=()=>{I(!1),M(""),Z(!0)},Re=({criteria:s,order:t})=>{const r=[...x].sort((a,o)=>{var u,m;let i="",n="";if(s==="name")i=a.name.toLowerCase(),n=o.name.toLowerCase();else if(s==="type"){const j=a.type==="file"?((u=a.name.split(".").pop())==null?void 0:u.toLowerCase())||"":"0",A=o.type==="file"?((m=o.name.split(".").pop())==null?void 0:m.toLowerCase())||"":"0";if(i=j,n=A,a.type==="folder"&&o.type!=="folder")return t==="asc"?-1:1;if(a.type!=="folder"&&o.type==="folder")return t==="asc"?1:-1}return t==="asc"?i.localeCompare(n):n.localeCompare(i)});D(r)},P=c.useCallback(s=>{s.key==="Escape"&&(v&&se(),w&&te(),E&&re())},[v,w,E]);c.useEffect(()=>(v||w||E?window.addEventListener("keydown",P):window.removeEventListener("keydown",P),()=>{window.removeEventListener("keydown",P)}),[v,w,E,P]);const Te=()=>{const s=p.split("/").filter(Boolean);if(s.length>1){s.pop();const t=s.join("/");F(t)}else F("public")},Le=p!==`public/${b}`||O<=1;c.useMemo(()=>je(),[b]);const oe={Dicatho:{backgroundClass:"bg-dicatho",textColor:"text-white"},Pachinos:{backgroundClass:"bg-pachinos",textColor:"text-white"},CEPAC:{backgroundClass:"bg-cepac",textColor:"text-white"},VSP:{backgroundClass:"bg-vsp",textColor:"text-white"},"La Penitencia":{backgroundClass:"bg-penitencia",textColor:"text-black"}},Ue=s=>{const t=s.split("/");return t.length>1?t[1]:null},$e=s=>{const t=Ue(s.path);return t&&oe[t]?oe[t]:{backgroundClass:"bg-white",textColor:"text-black"}};return e.jsxs(e.Fragment,{children:[O!==null&&b&&!X&&e.jsx(Zs,{currentPath:p,onNavigateTo:F,hierarchyLevel:O,companyName:b}),e.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[e.jsx(Ve,{onCreateFolder:we,onUploadFolder:Be,onUploadFile:Ne,onDownloadFile:Se,onDelete:ke,onCopy:Ie,onRename:De,onMove:Pe,onSort:Re,isItemSelected:d.length>0,onCopyHere:Me,onCancelCopy:se,isCopying:v,onMoveHere:Ae,onCancelMove:te,isMoving:w,onBack:Te,canGoBack:Le,selectedItemsCount:d.length}),V&&e.jsx(C,{isOpen:!0,title:"Subiendo Archivos",onClose:()=>{},canClose:!1,children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),e.jsxs("p",{children:["Subiendo ",V.completed," de ",V.total," archivos."]})]})}),q&&e.jsx(C,{isOpen:!0,title:"Eliminando Archivos",onClose:()=>{},canClose:!1,children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),e.jsxs("p",{children:["Eliminando ",q.completed," de ",q.total," archivos."]})]})}),e.jsxs(C,{isOpen:pe,title:"Crear Nueva Carpeta",onClose:()=>S(!1),children:[e.jsx("input",{type:"text",value:R,onChange:s=>K(s.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),e.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>S(!1),children:"Cancelar"}),e.jsx("button",{className:"btn btn-primary",onClick:Ee,children:"Crear"})]})]}),_&&k&&k.type&&e.jsx(Us,{isOpen:_,fileUrl:k.url,fileType:k.type,onClose:()=>G(!1)}),e.jsx(C,{isOpen:E,title:`Renombrar ${Q?"Archivo":"Carpeta"}`,onClose:()=>I(!1),children:e.jsxs("form",{onSubmit:Oe,children:[e.jsx("div",{className:"flex flex-col space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"label",children:e.jsxs("span",{className:"label-text",children:["Nombre ",Q?"de archivo":"de carpeta"]})}),e.jsx("input",{type:"text",value:z,onChange:s=>M(s.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]})}),e.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:re,children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),e.jsx("div",{className:"p-4",children:X?e.jsx("div",{className:"flex justify-center items-center",children:e.jsx("span",{className:"loading loading-dots loading-lg text-primary"})}):x.length===0?e.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):e.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:x.map(s=>{const{backgroundClass:t,textColor:r}=$e(s),a=d.includes(s.path);return e.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center relative ${a?"bg-blue-100":t} hover:bg-gray-200 transition-colors duration-200`,onClick:o=>be(s.path,o),onDoubleClick:()=>ve(s),children:[e.jsx("span",{className:`text-4xl ${a?"text-black":r}`,children:s.type==="folder"?e.jsx($s,{}):Fe(s.name)}),e.jsx("span",{className:`mt-2 text-center truncate w-full ${a?"text-black":r}`,children:s.name}),a&&e.jsx("span",{className:"absolute top-2 right-2 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center",children:"✓"})]},s.path)})})})]}),e.jsxs(C,{isOpen:ue,title:fe,onClose:()=>H(!1),children:[e.jsx("p",{children:he}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{className:"btn",onClick:()=>H(!1),children:"Aceptar"})})]}),B&&e.jsx(C,{isOpen:!0,title:B.type==="copy"?"Copiando Archivos":"Moviendo Archivos",onClose:()=>{},canClose:!1,children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),e.jsxs("p",{children:[B.type==="copy"?"Copiando":"Moviendo"," ",B.completed," de ",B.total," archivos."]})]})})]})};export{ut as default};
