import{q as ss,r as l,j as s,a as ts}from"./app-DZe2hMUz.js";import{F as os,B as as,b as rs,c as ns,d as ls,e as is,f as cs,g as ps,h as ms,i as ds,j as us,k as fs,l as xs,m as ys,n as hs,o as gs,p as js,q as Cs,s as bs,t as Fs,u as ws,v as vs,x as Es,y as Ns,z as Bs,A as Ss,C as Is,D as ks,E as Ms,G as Ps,H as As,I as Os,J as Ts,K as Ds,L as Rs,N as Ls,O as Us,P as $s,Q as Hs,R as zs,S as Vs,T as qs,U as Js,V as Ks,W as _s,X as Gs,Y as Xs,Z as Ws,_ as Ys,a0 as Qs}from"./Toolbar-EkdcESaR.js";import y from"./Modal-CKyZoIHr.js";import Zs from"./FileViewerModal-DHc-qInR.js";import{F as et,a as st}from"./FileViewer-B-w47WO7.js";import{getFilesTree as tt,createFolder as ot,uploadDirectory as he,uploadFile as at,downloadFile as rt,downloadFolder as nt,deleteFile as lt,deleteFolder as it,copyItems as ct,moveItems as pt,renameItem as mt}from"./fileManagerApi-CTusmRzo.js";import dt from"./Breadcrumb-DTmbohRi.js";import"./iconBase-D9vIHDPp.js";import"./index-CK_YFGyg.js";import"./AuthProvider-DWQfq4b2.js";import"./portal-P4KYJdfe.js";import"./use-server-handoff-complete-DVFPa0jq.js";const Nt=()=>{var ye;const{auth:ge}=ss().props;(ye=ge.user)!=null&&ye.permissions;const[m,h]=l.useState([]),[d,K]=l.useState([]),[p,E]=l.useState(""),[N,je]=l.useState(null),[M,Ce]=l.useState([]),[_,be]=l.useState(1),[Fe,P]=l.useState(!1),[G,ee]=l.useState(""),[se,te]=l.useState(!1),[A,we]=l.useState(null),[oe,ve]=l.useState(!0),[B,O]=l.useState(!1),[T,D]=l.useState(null),[S,R]=l.useState(!1),[L,U]=l.useState(null),[Ee,X]=l.useState(!1),[Ne,Be]=l.useState(""),[Se,Ie]=l.useState(""),[ut,ke]=l.useState("success"),[I,$]=l.useState(!1),[W,H]=l.useState(""),[ae,re]=l.useState(!0),[Y,g]=l.useState(null),[Q,Z]=l.useState(null),Me=()=>{switch(N){case"Dicatho":return"bg-dicatho";case"Pachinos":return"bg-pachinos";case"CEPAC":return"bg-cepac";default:return"bg-white"}},[k,j]=l.useState(null),[Pe,C]=l.useState([]),[ne,b]=l.useState(!1),[F,w]=l.useState(null),[z,V]=l.useState(null);l.useEffect(()=>{(async()=>{try{await Ae(),await x(),le(M,p),h([])}catch(t){console.error("Error al inicializar datos:",t)}finally{ve(!1)}})()},[]),l.useEffect(()=>{M.length>0&&p&&le(M,p)},[M,p]);const Ae=async()=>{try{const e=await ts.get("/filemanager/hierarchy-company",{withCredentials:!0}),{hierarchy_level:t,company_name:o}=e.data;be(t),je(o);const r=`public/${o}`;E(r)}catch(e){console.error("Error al obtener jerarquía y empresa:",e)}},x=async()=>{try{const e=await tt(),t=r=>r.sort((a,c)=>a.name.localeCompare(c.name)).map(a=>(a.type==="folder"&&a.children&&(a.children=t(a.children)),a)),o=t(e);Ce([{name:"public",path:"public",type:"folder",children:o}])}catch(e){console.error("Error fetching files tree:",e),i("Error","Error al obtener el árbol de archivos.","error")}},le=(e,t)=>{var n,u;const o=t.split("/").filter(Boolean);let r={children:e};for(const f of o){const v=(n=r.children)==null?void 0:n.find(J=>J.name===f&&J.type==="folder");if(v)r=v;else{console.error("Ruta no encontrada en el árbol:",t),K([]);return}}let a=1;const c=((u=r.children)==null?void 0:u.map(f=>({id:a++,name:f.name,type:f.type,date:new Date,path:f.path})))||[];c.sort((f,v)=>f.name.localeCompare(v.name)),K(c)},Oe=e=>{var o;switch((o=e.split(".").pop())==null?void 0:o.toLowerCase()){case"aac":return s.jsx(Qs,{});case"ai":return s.jsx(Ys,{});case"bmp":return s.jsx(Ws,{});case"cs":return s.jsx(Xs,{});case"css":return s.jsx(Gs,{});case"csv":return s.jsx(_s,{});case"doc":return s.jsx(Ks,{});case"docx":return s.jsx(Js,{});case"exe":return s.jsx(qs,{});case"gif":return s.jsx(Vs,{});case"heic":return s.jsx(zs,{});case"html":return s.jsx(Hs,{});case"java":return s.jsx($s,{});case"jpg":case"jpeg":return s.jsx(Us,{});case"js":return s.jsx(Ls,{});case"json":return s.jsx(Rs,{});case"jsx":return s.jsx(Ds,{});case"key":return s.jsx(Ts,{});case"m4p":return s.jsx(Os,{});case"md":return s.jsx(As,{});case"mdx":return s.jsx(Ps,{});case"mov":return s.jsx(Ms,{});case"mp3":return s.jsx(ks,{});case"mp4":return s.jsx(Is,{});case"otf":return s.jsx(Ss,{});case"pdf":return s.jsx(Bs,{});case"php":return s.jsx(Ns,{});case"png":return s.jsx(Es,{});case"ppt":return s.jsx(vs,{});case"pptx":return s.jsx(ws,{});case"psd":return s.jsx(Fs,{});case"py":return s.jsx(bs,{});case"raw":return s.jsx(Cs,{});case"rb":return s.jsx(js,{});case"sass":return s.jsx(gs,{});case"scss":return s.jsx(hs,{});case"sh":return s.jsx(ys,{});case"sql":return s.jsx(xs,{});case"svg":return s.jsx(fs,{});case"tiff":return s.jsx(us,{});case"tsx":return s.jsx(ds,{});case"ttf":return s.jsx(ms,{});case"txt":return s.jsx(ps,{});case"wav":return s.jsx(cs,{});case"woff":return s.jsx(is,{});case"xls":return s.jsx(ls,{});case"xlsx":return s.jsx(ns,{});case"xml":return s.jsx(rs,{});case"yml":return s.jsx(as,{});default:return s.jsx(st,{})}},Te=(e,t)=>{t.ctrlKey||t.metaKey?h(o=>o.includes(e)?o.filter(r=>r!==e):[...o,e]):h(o=>o.includes(e)&&o.length===1?[]:[e])},De=e=>{var t;if(e.type==="folder")E(e.path);else{const o=(t=e.name.split(".").pop())==null?void 0:t.toLowerCase();o&&["pdf","docx","xlsx","xls","csv","txt","doc"].includes(o)?(we({url:`/filemanager/files/view?filename=${encodeURIComponent(e.name)}&path=${encodeURIComponent(p)}`,type:o}),te(!0)):i("Error","Tipo de archivo no soportado para visualización.","error")}},i=(e,t,o)=>{Be(e),Ie(t),ke(o),X(!0)},Re=()=>{P(!0)},Le=async()=>{if(G.trim()===""){i("Error","El nombre de la carpeta no puede estar vacío.","error");return}try{const e=await ot(G,p);i("Éxito","Carpeta creada exitosamente.","success"),await x(),ee(""),P(!1)}catch(e){e.response&&e.response.status===403?i("Error","No tienes permiso para crear carpetas.","error"):i("Error","Error al crear la carpeta.","error"),console.error(e)}},Ue=async()=>{const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.onchange=async()=>{if(e.files&&e.files.length>0){const t=e.files.length;let o=0;g({total:t,completed:0});try{const r=d.map(n=>n.name),c=Array.from(e.files).map(n=>{const u=n.webkitRelativePath.split("/");return u[u.length-1]}).filter(n=>r.includes(n));c.length>0?(C(c),V(e.files),w("uploadDirectory"),b(!0)):(await he(e.files,p),o=t,g({total:t,completed:o}),i("Éxito","Carpeta subida exitosamente.","success"),x())}catch{i("Error","Error al subir la carpeta.","error")}finally{g(null)}}},e.click()},$e=async()=>{const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=async()=>{if(e.files&&e.files.length>0){const t=d.map(a=>a.name),r=Array.from(e.files).map(a=>a.name).filter(a=>t.includes(a));r.length>0?(C(r),V(e.files),w("upload"),b(!0)):await ie(Array.from(e.files))}},e.click()},ie=async(e,t=!1)=>{var a,c;const o=e.length;let r=0;g({total:o,completed:0});try{for(const n of e)await at(n,p,t),r+=1,g({total:o,completed:r});i("Éxito","Archivos subidos exitosamente.","success"),x()}catch(n){((c=(a=n.response)==null?void 0:a.data)==null?void 0:c.exception)==="Illuminate\\Http\\Exceptions\\PostTooLargeException"?i("Error","Uno de los archivos supera el límite de 10MB.","error"):i("Error","Error al subir uno o más archivos.","error")}finally{g(null)}},He=async()=>{var e,t;if(m.length>0)try{for(const o of m){const r=d.find(a=>a.path===o);if(r){if(r.type==="file"){const a=await rt(r.name,p),c=window.URL.createObjectURL(new Blob([a])),n=document.createElement("a");n.href=c,n.setAttribute("download",r.name),document.body.appendChild(n),n.click(),(e=n.parentNode)==null||e.removeChild(n)}else if(r.type==="folder"){const a=await nt(r.name,p),c=window.URL.createObjectURL(new Blob([a])),n=document.createElement("a");n.href=c,n.setAttribute("download",`${r.name}.zip`),document.body.appendChild(n),n.click(),(t=n.parentNode)==null||t.removeChild(n)}}}i("Éxito","Elemento(s) descargado(s) exitosamente.","success")}catch(o){o.response&&o.response.status===403?i("Error","No tienes permiso para descargar uno o más elementos.","error"):i("Error","Error al descargar uno o más elementos.","error"),console.error(o)}else i("Error","Por favor, selecciona al menos un elemento para descargar.","error")},ze=async()=>{if(m.length>0&&window.confirm(`¿Estás seguro de que deseas eliminar ${m.length} elemento(s)?`)){const t=m.length;let o=0;Z({total:t,completed:0});try{for(const r of m){const a=d.find(c=>c.path===r);a&&(a.type==="file"?await lt(a.name,p):a.type==="folder"&&await it(a.name,p),o+=1,Z({total:t,completed:o}))}i("Éxito","Elemento(s) eliminado(s) exitosamente.","success"),x()}catch{i("Error","Error al eliminar uno o más elementos.","error")}finally{Z(null)}}},Ve=async()=>{if(m.length>0){const e=m.map(t=>{const o=d.find(r=>r.path===t);return o?{name:o.name,type:o.type}:null}).filter(Boolean);D({items:e,path:p}),O(!0)}},qe=async()=>{if(T){const{items:e,path:t}=T,o=d.map(a=>a.name),r=e.filter(a=>o.includes(a.name));r.length>0?(C(r.map(a=>a.name)),w("copy"),b(!0)):await ce(e,t,p)}},ce=async(e,t,o,r=!1)=>{const a=e.length;let c=0;j({type:"copy",total:a,completed:c});try{await ct(e,t,o,r),c=a,j({type:"copy",total:a,completed:c}),i("Éxito","Elemento(s) copiado(s) exitosamente.","success"),x(),O(!1),D(null),h([])}catch(n){n.response&&n.response.status===403?i("Error","No tienes permiso para copiar uno o más elementos.","error"):n.response&&n.response.data.error?i("Error",n.response.data.error,"error"):i("Error","Error al copiar uno o más elementos.","error"),console.error(n)}finally{j(null)}},pe=()=>{O(!1),D(null)},Je=async()=>{if(m.length>0){const e=m.map(t=>{const o=d.find(r=>r.path===t);return o?{name:o.name,type:o.type}:null}).filter(Boolean);U({items:e,path:p}),R(!0)}},Ke=async()=>{if(L){const{items:e,path:t}=L,o=d.map(a=>a.name),r=e.filter(a=>o.includes(a.name));r.length>0?(C(r.map(a=>a.name)),w("move"),b(!0)):await me(e,t,p)}},me=async(e,t,o,r=!1)=>{const a=e.length;let c=0;j({type:"move",total:a,completed:c});try{await pt(e,t,o,r),c=a,j({type:"move",total:a,completed:c}),i("Éxito","Elemento(s) movido(s) exitosamente.","success"),x(),R(!1),U(null),h([])}catch(n){n.response&&n.response.status===403?i("Error","No tienes permiso para mover uno o más elementos.","error"):i("Error","Error al mover uno o más elementos.","error"),console.error(n)}finally{j(null)}},de=()=>{R(!1),U(null)},_e=async()=>{if(F==="upload"&&z)await ie(Array.from(z),!0);else if(F==="uploadDirectory"&&z)await he(z,p,!0);else if(F==="copy"&&T){const{items:e,path:t}=T;await ce(e,t,p,!0)}else if(F==="move"&&L){const{items:e,path:t}=L;await me(e,t,p,!0)}b(!1),C([]),w(null),V(null)},ue=()=>{b(!1),C([]),w(null),V(null),F==="copy"?(O(!1),D(null)):F==="move"&&(R(!1),U(null))},Ge=()=>{if(m.length===1){const e=m[0],t=d.find(o=>o.path===e);if(t){const o=t.type==="file"&&t.name.slice(0,t.name.lastIndexOf("."))||t.name;H(o),re(t.type==="file"),$(!0)}}else i("Error","Solo puedes renombrar un elemento a la vez.","error")},Xe=async e=>{if(e.preventDefault(),W.trim()===""){i("Error","El nombre del elemento no puede estar vacío.","error");return}const t=m[0],o=d.find(n=>n.path===t);if(!o){i("Error","Elemento seleccionado no encontrado.","error");return}const r=o.name;let a=W;if(o.type==="file"){const n=o.name.lastIndexOf("."),u=n!==-1?o.name.slice(n):"";a+=u}const c=o.type;try{const n={old_name:r,new_name:a,path:p,type:c};console.log("Renombrando:",n);const u=await mt(n);i("Éxito",u.message,"success"),x(),h([]),$(!1),H("")}catch(n){n.response&&n.response.status===403?i("Error","No tienes permiso para renombrar este elemento.","error"):n.response&&n.response.data.error?i("Error",n.response.data.error,"error"):i("Error","Error al renombrar el elemento.","error"),console.error(n)}},fe=()=>{$(!1),H(""),re(!0)},We=({criteria:e,order:t})=>{const o=[...d].sort((r,a)=>{var u,f;let c="",n="";if(e==="name")c=r.name.toLowerCase(),n=a.name.toLowerCase();else if(e==="type"){const v=r.type==="file"?((u=r.name.split(".").pop())==null?void 0:u.toLowerCase())||"":"0",J=a.type==="file"?((f=a.name.split(".").pop())==null?void 0:f.toLowerCase())||"":"0";if(c=v,n=J,r.type==="folder"&&a.type!=="folder")return t==="asc"?-1:1;if(r.type!=="folder"&&a.type==="folder")return t==="asc"?1:-1}return t==="asc"?c.localeCompare(n):n.localeCompare(c)});K(o)},q=l.useCallback(e=>{e.key==="Escape"&&(B&&pe(),S&&de(),I&&fe())},[B,S,I]);l.useEffect(()=>(B||S||I?window.addEventListener("keydown",q):window.removeEventListener("keydown",q),()=>{window.removeEventListener("keydown",q)}),[B,S,I,q]);const Ye=()=>{const e=p.split("/").filter(Boolean);if(e.length>1){e.pop();const t=e.join("/");E(t)}else E("public")},Qe=p!==`public/${N}`||_<=1;l.useMemo(()=>Me(),[N]);const xe={Dicatho:{backgroundClass:"bg-dicatho",textColor:"text-white"},Pachinos:{backgroundClass:"bg-pachinos",textColor:"text-white"},CEPAC:{backgroundClass:"bg-cepac",textColor:"text-white"},VSP:{backgroundClass:"bg-vsp",textColor:"text-white"},"La Penitencia":{backgroundClass:"bg-penitencia",textColor:"text-black"}},Ze=e=>{const t=e.split("/");return t.length>1?t[1]:null},es=e=>{const t=Ze(e.path);return t&&xe[t]?xe[t]:{backgroundClass:"bg-white",textColor:"text-black"}};return s.jsxs(s.Fragment,{children:[_!==null&&N&&!oe&&s.jsx(dt,{currentPath:p,onNavigateTo:E,hierarchyLevel:_,companyName:N}),s.jsxs("div",{className:"file-manager bg-white min-h-fit",children:[s.jsx(os,{onCreateFolder:Re,onUploadFolder:Ue,onUploadFile:$e,onDownloadFile:He,onDelete:ze,onCopy:Ve,onRename:Ge,onMove:Je,onSort:We,isItemSelected:m.length>0,onCopyHere:qe,onCancelCopy:pe,isCopying:B,onMoveHere:Ke,onCancelMove:de,isMoving:S,onBack:Ye,canGoBack:Qe,selectedItemsCount:m.length}),Y&&s.jsx(y,{isOpen:!0,title:"Subiendo Archivos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:["Subiendo ",Y.completed," de ",Y.total," archivos."]})]})}),Q&&s.jsx(y,{isOpen:!0,title:"Eliminando Archivos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:["Eliminando ",Q.completed," de ",Q.total," archivos."]})]})}),s.jsxs(y,{isOpen:Fe,title:"Crear Nueva Carpeta",onClose:()=>P(!1),children:[s.jsx("input",{type:"text",value:G,onChange:e=>ee(e.target.value),placeholder:"Nombre de la carpeta",className:"input input-bordered w-full"}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{className:"btn btn-secondary",onClick:()=>P(!1),children:"Cancelar"}),s.jsx("button",{className:"btn btn-primary",onClick:Le,children:"Crear"})]})]}),se&&A&&A.type&&s.jsx(Zs,{isOpen:se,fileUrl:A.url,fileType:A.type,onClose:()=>te(!1)}),s.jsx(y,{isOpen:I,title:`Renombrar ${ae?"Archivo":"Carpeta"}`,onClose:()=>$(!1),children:s.jsxs("form",{onSubmit:Xe,children:[s.jsx("div",{className:"flex flex-col space-y-4",children:s.jsxs("div",{children:[s.jsx("label",{className:"label",children:s.jsxs("span",{className:"label-text",children:["Nombre ",ae?"de archivo":"de carpeta"]})}),s.jsx("input",{type:"text",value:W,onChange:e=>H(e.target.value),className:"input input-bordered w-full",placeholder:"Nombre"})]})}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{type:"button",className:"btn btn-secondary",onClick:fe,children:"Cancelar"}),s.jsx("button",{type:"submit",className:"btn btn-primary",children:"Renombrar"})]})]})}),s.jsx("div",{className:"p-4",children:oe?s.jsx("div",{className:"flex justify-center items-center",children:s.jsx("span",{className:"loading loading-dots loading-lg text-primary"})}):d.length===0?s.jsx("p",{className:"text-center text-gray-500",children:"No hay archivos o carpetas disponibles."}):s.jsx("ul",{className:"grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",children:d.map(e=>{const{backgroundClass:t,textColor:o}=es(e),r=m.includes(e.path);return s.jsxs("li",{className:`p-4 border rounded-lg cursor-pointer flex flex-col items-center relative ${r?"bg-blue-100":t} hover:bg-gray-200 transition-colors duration-200`,onClick:a=>Te(e.path,a),onDoubleClick:()=>De(e),children:[s.jsx("span",{className:`text-4xl ${r?"text-black":o}`,children:e.type==="folder"?s.jsx(et,{}):Oe(e.name)}),s.jsx("span",{className:`mt-2 text-center truncate w-full ${r?"text-black":o}`,children:e.name}),r&&s.jsx("span",{className:"absolute top-2 right-2 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center",children:"✓"})]},e.path)})})})]}),s.jsxs(y,{isOpen:Ee,title:Ne,onClose:()=>X(!1),children:[s.jsx("p",{children:Se}),s.jsx("div",{className:"flex justify-end mt-4",children:s.jsx("button",{className:"btn",onClick:()=>X(!1),children:"Aceptar"})})]}),k&&s.jsx(y,{isOpen:!0,title:k.type==="copy"?"Copiando Elementos":"Moviendo Elementos",onClose:()=>{},canClose:!1,children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("span",{className:"loading loading-spinner loading-lg text-primary"}),s.jsxs("p",{children:[k.type==="copy"?"Copiando":"Moviendo"," ",k.completed," de ",k.total," elementos."]})]})}),ne&&s.jsxs(y,{isOpen:ne,title:"Conflicto de Elementos",onClose:ue,children:[s.jsx("p",{children:"Los siguientes elementos ya existen en el directorio destino:"}),s.jsx("ul",{className:"list-disc list-inside",children:Pe.map(e=>s.jsx("li",{children:e},e))}),s.jsx("p",{children:"¿Deseas sobrescribirlos?"}),s.jsxs("div",{className:"flex justify-end mt-4 space-x-2",children:[s.jsx("button",{className:"btn btn-secondary",onClick:ue,children:"Cancelar"}),s.jsx("button",{className:"btn btn-primary",onClick:_e,children:"Sobrescribir"})]})]})]})};export{Nt as default};
