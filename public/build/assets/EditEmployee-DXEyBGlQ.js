import{r as p,b as j,j as e}from"./app-vsYF5F6T.js";import{u as U,C as c}from"./index.esm-DOpgG1dT.js";const I=({employee:l,positions:b,companies:k,onClose:v})=>{const{control:t,handleSubmit:z,setValue:m,watch:_,getValues:x,formState:{errors:i,isValid:y},reset:N}=U({mode:"onChange",defaultValues:{first_name:"",last_name_1:"",last_name_2:"",username:"",position_id:"",company_id:"",password:"",password_confirmation:"",enable_permissions:!1,selected_permissions:[]}}),[A,F]=p.useState([]),[L,w]=p.useState([]),[$,f]=p.useState(!1),[Z,g]=p.useState(!1),[d,u]=p.useState(1),q=2,r=_(),C=_("password"),S=_("password_confirmation"),V=_("enable_permissions"),E=_("company_id"),P={Empresas:["can_create_companies","can_delete_companies","can_update_companies"],Puestos:["can_create_positions","can_update_positions","can_delete_positions"],Empleados:["can_create_employees","can_delete_employees","can_update_employees","can_view_company_employees","can_view_all_employees"],"Gestión de Archivos y Carpetas":["can_view_file_explorer","can_open_files","can_upload_files_and_folders","can_create_folders","can_download_files_and_folders","can_copy_files","can_move_files","can_rename_files_and_folders","can_delete_files_and_folders"]},R=Object.keys(P).map(s=>({category:s,permissions:A.filter(a=>P[s].includes(a.name))}));p.useEffect(()=>{j.get("/api/permissions").then(s=>F(s.data)).catch(s=>console.error("Error al cargar los permisos",s)),j.get(`/api/employees/${l.id}/permissions`).then(s=>{const a=s.data.map(o=>o.id),n={first_name:l.first_name,last_name_1:l.last_name_1,last_name_2:l.last_name_2||"",username:l.username,position_id:l.position_id?l.position_id.toString():"",company_id:l.company_id?l.company_id.toString():"",password:"",password_confirmation:"",enable_permissions:a.length>0,selected_permissions:a};N(n);const h=b.filter(o=>o.company_id===Number(n.company_id));w(h),n.position_id&&h.some(o=>o.id.toString()===n.position_id)?m("position_id",n.position_id):m("position_id","")}).catch(s=>console.error("Error al cargar los permisos del empleado",s))},[l.id,l.first_name,l.last_name_1,l.last_name_2,l.username,l.position_id,l.company_id,b,N,m]),p.useEffect(()=>{const s=b.filter(n=>n.company_id===Number(E));w(s);const a=x("position_id");a&&!s.some(n=>n.id.toString()===a)&&m("position_id","")},[E,b,m,x]);const G=s=>{const a=x("selected_permissions");a.includes(s)?m("selected_permissions",a.filter(n=>n!==s)):m("selected_permissions",[...a,s])},M=s=>{if(d<q)u(d+1);else{const a={...s,position_id:s.position_id,company_id:s.company_id,...s.password?{password:s.password,password_confirmation:s.password_confirmation}:{}};j.patch(`/admin/employees/${l.id}`,a).then(n=>{const h=l.id;s.enable_permissions?j.post("/api/userpermissions",{employee_id:h,permissions:s.selected_permissions}).then(()=>{f(!0),N(),u(1)}).catch(o=>{console.error("Error al asignar permisos",o),g(!0)}):j.delete(`/api/userpermissions/${h}`).then(()=>{f(!0),N(),u(1)}).catch(o=>{console.error("Error al eliminar permisos",o),g(!0)})}).catch(n=>{console.error("Error al actualizar el empleado",n),g(!0)})}};return e.jsx("div",{className:"modal modal-open",children:e.jsxs("div",{className:"modal-box w-11/12 max-w-5xl",children:[e.jsx("h1",{className:"text-2xl text-center font-bold my-4",children:"Editar Empleado"}),e.jsxs("ul",{className:"steps w-full",children:[e.jsx("li",{className:`step ${d>=1?"step-primary":""}`,children:"Datos del empleado"}),e.jsx("li",{className:`step ${d===2?"step-primary":""}`,children:"Permisos"})]}),e.jsxs("form",{onSubmit:z(M),children:[d===1&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Nombre(s)"}),e.jsx(c,{name:"first_name",control:t,rules:{required:"El nombre es obligatorio",maxLength:{value:50,message:"El nombre no debe exceder los 50 caracteres"},pattern:{value:/^[a-zA-ZÀ-ÿ\s]+$/,message:"El nombre solo puede contener letras"}},render:({field:s})=>e.jsx("input",{...s,className:"input__data__entry",placeholder:"Nombre(s)"})})]}),i.first_name&&e.jsx("p",{className:"text-red-600",children:i.first_name.message}),r.first_name&&e.jsxs(e.Fragment,{children:[r.first_name.length<3&&e.jsx("p",{className:"text-red-600",children:"El nombre no debe tener menos de 3 caracteres"}),r.first_name.length>50&&e.jsx("p",{className:"text-red-600",children:"El nombre no debe exceder los 50 caracteres"}),r.first_name.match(/[^a-zA-ZÀ-ÿ\s]/)&&e.jsx("p",{className:"text-red-600",children:"El nombre solo puede contener letras"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Primer apellido"}),e.jsx(c,{name:"last_name_1",control:t,rules:{required:"El primer apellido es obligatorio",maxLength:{value:50,message:"El primer apellido no debe exceder los 50 caracteres"},pattern:{value:/^[a-zA-ZÀ-ÿ]+$/,message:"El primer apellido solo puede contener letras sin espacios"}},render:({field:s})=>e.jsx("input",{...s,className:"input__data__entry",placeholder:"Primer apellido"})})]}),i.last_name_1&&e.jsx("p",{className:"text-red-600",children:i.last_name_1.message}),r.last_name_1&&e.jsxs(e.Fragment,{children:[r.last_name_1.length<3&&e.jsx("p",{className:"text-red-600",children:"El primer apellido no debe tener menos de 3 caracteres"}),r.last_name_1.length>50&&e.jsx("p",{className:"text-red-600",children:"El primer apellido no debe exceder los 50 caracteres"}),r.last_name_1.includes(" ")&&e.jsx("p",{className:"text-red-600",children:"El primer apellido no debe tener espacios"}),r.last_name_1.match(/[^a-zA-ZÀ-ÿ]/)&&e.jsx("p",{className:"text-red-600",children:"El primer apellido solo puede contener letras"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Segundo apellido"}),e.jsx(c,{name:"last_name_2",control:t,rules:{maxLength:{value:50,message:"El segundo apellido no debe exceder los 50 caracteres"},pattern:{value:/^[a-zA-ZÀ-ÿ]*$/,message:"El segundo apellido solo puede contener letras sin espacios"}},render:({field:s})=>e.jsx("input",{...s,className:"input__data__entry",placeholder:"Segundo apellido"})})]}),i.last_name_2&&e.jsx("p",{className:"text-red-600",children:i.last_name_2.message}),r.last_name_2&&e.jsxs(e.Fragment,{children:[r.last_name_2.length<3&&e.jsx("p",{className:"text-red-600",children:"El segundo apellido no debe tener menos de 3 caracteres"}),r.last_name_2.length>50&&e.jsx("p",{className:"text-red-600",children:"El segundo apellido no debe exceder los 50 caracteres"}),r.last_name_2.includes(" ")&&e.jsx("p",{className:"text-red-600",children:"El segundo apellido no debe tener espacios"}),r.last_name_2.match(/[^a-zA-ZÀ-ÿ]/)&&e.jsx("p",{className:"text-red-600",children:"El segundo apellido solo puede contener letras"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Nombre de usuario (CURP)"}),e.jsx(c,{name:"username",control:t,rules:{required:"El nombre de usuario es obligatorio",maxLength:{value:18,message:"El nombre de usuario no debe exceder los 18 caracteres"},pattern:{value:/^[a-zA-Z0-9]+$/,message:"El nombre de usuario solo puede contener letras y números sin espacios"}},render:({field:s})=>e.jsx("input",{...s,className:"input__data__entry",placeholder:"Nombre de usuario (CURP)"})})]}),i.username&&e.jsx("p",{className:"text-red-600",children:i.username.message}),r.username&&e.jsxs(e.Fragment,{children:[r.username.length<3&&e.jsx("p",{className:"text-red-600",children:"El nombre de usuario no debe tener menos de 3 caracteres"}),r.username.length>18&&e.jsx("p",{className:"text-red-600",children:"El nombre de usuario no debe exceder los 18 caracteres"}),r.username.includes(" ")&&e.jsx("p",{className:"text-red-600",children:"El nombre de usuario no debe tener espacios"}),r.username.match(/[^a-zA-Z0-9]/)&&e.jsx("p",{className:"text-red-600",children:"El nombre de usuario solo puede contener letras y números"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Empresa"}),e.jsx(c,{name:"company_id",control:t,rules:{required:"La empresa es obligatoria"},render:({field:s})=>e.jsxs("select",{...s,className:"input__data__entry",children:[e.jsx("option",{value:"",children:"Seleccione una empresa"}),k.map(a=>e.jsx("option",{value:a.id.toString(),children:a.name},a.id))]})})]}),i.company_id&&e.jsx("p",{className:"text-red-600",children:i.company_id.message}),r.company_id===""&&e.jsx("p",{className:"text-red-600",children:"La empresa es obligatoria"}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Puesto"}),e.jsx(c,{name:"position_id",control:t,rules:{required:"El puesto es obligatorio"},render:({field:s})=>e.jsxs("select",{...s,className:"input__data__entry",disabled:!E,children:[e.jsx("option",{value:"",children:"Seleccione un puesto"}),L.map(a=>e.jsx("option",{value:a.id.toString(),children:a.name},a.id))]})})]}),i.position_id&&e.jsx("p",{className:"text-red-600",children:i.position_id.message}),r.company_id===""&&e.jsx("p",{className:"text-red-600",children:"Antes debes seleccionar una empresa"}),r.position_id===""&&e.jsx("p",{className:"text-red-600",children:"El puesto es obligatorio"}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Contraseña (opcional)"}),e.jsx(c,{name:"password",control:t,rules:{minLength:{value:4,message:"La contraseña debe tener al menos 4 caracteres"}},render:({field:s})=>e.jsx("input",{...s,type:"password",className:"input__data__entry",placeholder:"Contraseña (dejar vacío si no desea cambiar)"})})]}),i.password&&e.jsx("p",{className:"text-red-600",children:i.password.message}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{children:"Confirmar contraseña"}),e.jsx(c,{name:"password_confirmation",control:t,rules:{validate:s=>s===x("password")||"Las contraseñas no coinciden"},render:({field:s})=>e.jsx("input",{...s,type:"password",className:"input__data__entry",placeholder:"Confirmar contraseña"})})]}),i.password_confirmation&&e.jsx("p",{className:"text-red-600",children:i.password_confirmation.message}),C&&S&&C!==S&&e.jsx("p",{className:"text-red-600",children:"Las contraseñas no coinciden"}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{type:"button",className:"btn btn-block",onClick:()=>u(d+1),disabled:!y,children:"Siguiente"})}),!y&&e.jsx("p",{className:"text-red-600",children:"Todos los campos son obligatorios"})]}),d===2&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4",children:e.jsxs("label",{htmlFor:"enable_permissions",className:"flex items-center",children:[e.jsx(c,{name:"enable_permissions",control:t,render:({field:s})=>e.jsx("input",{type:"checkbox",className:"checkbox checkbox-primary",checked:s.value,onChange:a=>s.onChange(a.target.checked),id:"enable_permissions"})}),e.jsx("span",{className:"ml-2",children:"Habilitar permisos"})]})}),V&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h2",{className:"mb-3 text-xl text-center font-bold",children:"Permisos"}),R.map(({category:s,permissions:a})=>e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:a.map(n=>e.jsxs("label",{className:"flex items-center my-2",children:[e.jsx("input",{type:"checkbox",checked:x("selected_permissions").includes(n.id),onChange:()=>G(n.id),className:"checkbox checkbox-primary mr-2"}),e.jsx("span",{children:n.description})]},n.id))})]},s))]}),e.jsxs("div",{className:"mt-4 flex justify-center",children:[e.jsx("button",{type:"button",className:"btn size-2/4 mr-1",onClick:()=>u(d-1),children:"Anterior"}),e.jsx("button",{type:"submit",className:"btn size-2/4 ml-1",children:"Guardar"})]})]})]}),$&&e.jsx("div",{className:"modal modal-open",children:e.jsxs("div",{className:"modal-box",children:[e.jsx("h3",{className:"font-bold text-lg",children:"¡Empleado actualizado con éxito!"}),e.jsx("div",{className:"modal-action",children:e.jsx("button",{className:"btn btn-primary",onClick:()=>{f(!1),v()},children:"Cerrar"})})]})}),Z&&e.jsx("div",{className:"modal modal-open",children:e.jsxs("div",{className:"modal-box",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Error al actualizar el empleado"}),e.jsx("div",{className:"modal-action",children:e.jsx("button",{className:"btn btn-primary",onClick:()=>g(!1),children:"Cerrar"})})]})}),e.jsx("div",{className:"modal-action",children:e.jsx("button",{className:"btn btn-error",onClick:v,children:"Cancelar"})})]})})};export{I as default};
